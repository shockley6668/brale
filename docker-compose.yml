services:
  brale:
    build:
      context: .
      dockerfile: Dockerfile.brale
    environment:
      BRALE_CONFIG: /app/configs/config.yaml
      FREQTRADE_API_URL: http://freqtrade:8080/api/v1
      #HTTP_PROXY: http://host.docker.internal:10080
      #HTTPS_PROXY: http://host.docker.internal:10080
      #NO_PROXY: localhost,127.0.0.1,brale,freqtrade
    depends_on:
      freqtrade:
        condition: service_healthy
    ports:
      - "9991:9991"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - type: bind
        source: ${BRALE_DATA_ROOT:-./running_log/brale_data}
        target: /data
      - type: bind
        source: ./configs
        target: /app/configs
        read_only: true
      - type: bind
        source: ./prompts
        target: /app/prompts
        read_only: true

  freqtrade:
    image: freqtradeorg/freqtrade:stable
    # 更适合中国宝宝体制的配置
    #environment:
      #HTTP_PROXY: http://host.docker.internal:10080
      #HTTPS_PROXY: http://host.docker.internal:10080
      #NO_PROXY: localhost,127.0.0.1,brale,freqtrade
    command:
      - "trade"
      - "--logfile"
      - "/freqtrade/user_data/logs/freqtrade.log"
      - "--db-url"
      - "sqlite:////freqtrade/user_data/tradesv3.sqlite"
      - "--config"
      - "/freqtrade/user_data/config.json"
      - "--strategy"
      - "BraleSharedStrategy"
    ports:
      - "8080:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/api/v1/ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    volumes:
      - type: bind
        source: ${FREQTRADE_USERDATA_ROOT:-./running_log/freqtrade_data}
        target: /freqtrade/user_data
