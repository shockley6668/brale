<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Brale Admin</title>
  <link rel="stylesheet" href="/admin/app.css" />
  <script src="https://unpkg.com/vue@3.4.21/dist/vue.global.prod.js"></script>
</head>
<body>
  <div id="app">
    <header class="app-header">
      <h1>Brale å®ç›˜ç›‘æ§</h1>
      <div class="actions">
        <button @click="manualRefresh" :disabled="loading">åˆ·æ–°</button>
        <label>
          è‡ªåŠ¨åˆ·æ–°
          <select v-model.number="refreshInterval">
            <option :value="0">å…³é—­</option>
            <option :value="10">10s</option>
            <option :value="30">30s</option>
            <option :value="60">60s</option>
          </select>
        </label>
        <div class="symbol-filter">
          <label>
            äº¤æ˜“å¯¹
            <input
              v-model="symbolInput"
              @keyup.enter="applySymbolFilter"
              placeholder="ä¾‹å¦‚ ETHUSDT"
            />
          </label>
          <button class="ghost" @click="applySymbolFilter">åº”ç”¨</button>
          <button class="ghost" @click="clearSymbolFilter" :disabled="!symbolFilter">æ¸…é™¤</button>
        </div>
        <div class="stage-filter">
          <label>
            é˜¶æ®µ
            <select v-model="stageFilter">
              <option
                v-for="opt in stageOptions"
                :key="opt.value"
                :value="opt.value"
              >
                {{ opt.label }}
              </option>
            </select>
          </label>
        </div>
      </div>
    </header>

    <section class="status-bar">
      <div>
        <strong>å†³ç­–è®°å½•</strong>
        <span>ç¬¬ {{ page }} é¡µ Â· æ¯é¡µ {{ pageSize }} æ¡ Â· {{ symbolFilter || 'å…¨éƒ¨äº¤æ˜“å¯¹' }}</span>
      </div>
      <div>
        <strong>ä»“ä½</strong>
        <span>{{ openPositionCount }} ä¸ªæŒä»“ / æœ€è¿‘å¹³ä»“ {{ historyCount }} æ¡</span>
      </div>
      <div v-if="error" class="error">{{ error }}</div>
    </section>

    <main class="grid">
      <section class="card traces">
        <div class="card-head">
          <h2>å†³ç­–æµç¨‹</h2>
          <div class="pagination">
            <button class="ghost" @click.stop="prevPage" :disabled="page === 1">ä¸Šä¸€é¡µ</button>
            <span>ç¬¬ {{ page }} é¡µ</span>
            <button class="ghost" @click.stop="nextPage" :disabled="!hasNext">ä¸‹ä¸€é¡µ</button>
          </div>
        </div>
        <div v-if="!traces.length" class="empty">æš‚æ— å®æ—¶å†³ç­–</div>
        <div v-for="trace in traces" :key="trace.trace_id" class="trace">
          <header @click="toggleTrace(trace.trace_id)">
            <div>
              <h3>{{ formatTraceTitle(trace) }}</h3>
              <small>{{ formatTs(trace.ts) }} Â· {{ trace.horizon }}</small>
            </div>
            <button>{{ expanded.has(trace.trace_id) ? 'æ”¶èµ·' : 'å±•å¼€' }}</button>
          </header>
          <transition name="fade">
            <div v-if="expanded.has(trace.trace_id)" class="steps">
              <div class="tab-bar" v-if="trace.steps.length">
                <button
                  class="tab"
                  :class="{ active: !activeTab[trace.trace_id] || activeTab[trace.trace_id] === 'ALL' }"
                  @click.stop="setActiveTab(trace.trace_id, 'ALL')"
                >
                  å…¨éƒ¨
                </button>
                <button
                  v-for="stage in traceStages(trace)"
                  :key="stage.key"
                  class="tab"
                  :class="{ active: activeTab[trace.trace_id] === stage.key }"
                  @click.stop="setActiveTab(trace.trace_id, stage.key)"
                >
                  {{ formatStageLabel(stage) }}
                </button>
              </div>
              <article v-for="(step, idx) in filteredSteps(trace)" :key="idx" class="step">
                <div class="step-head">
                  <div>
                    <span class="stage">{{ step.stage }}</span>
                    <span class="provider">{{ step.provider_id || 'n/a' }}</span>
                  </div>
                  <div class="step-meta">
                    <span
                      class="vision-flag"
                      :class="{ enabled: step.vision_supported }"
                    >
                      ğŸ–¼ï¸ {{ step.vision_supported ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ' }}
                    </span>
                    <span class="image-count">å›¾ç‰‡ {{ step.image_count || (step.images ? step.images.length : 0) }}</span>
                    <small>{{ formatTs(step.ts) }}</small>
                  </div>
                </div>
                <div class="step-body">
                  <p class="status" v-if="step.error">âš  {{ step.error }}</p>
                  <p class="status" v-else>{{ summarizeDecisions(step.decisions) || preview(step.meta_summary || step.raw_output || step.raw_json) }}</p>
                  <details>
                    <summary>æŸ¥çœ‹ Prompt</summary>
                    <div class="prompt-block">
                      <h4>System</h4>
                      <pre>{{ step.system_prompt || '-' }}</pre>
                    </div>
                    <div class="prompt-block">
                      <h4>User</h4>
                      <pre>{{ step.user_prompt || '-' }}</pre>
                    </div>
                  </details>
                  <details>
                    <summary>æŸ¥çœ‹è¾“å‡º</summary>
                    <pre>{{ step.raw_output || step.raw_json || step.meta_summary || '-' }}</pre>
                  </details>
                  <div v-if="step.images && step.images.length" class="images">
                    <figure v-for="(img, i) in step.images" :key="i">
                      <img :src="img.data_uri" :alt="img.description || 'image'" />
                      <figcaption>{{ img.description || 'LLM è¾“å…¥å›¾' }}</figcaption>
                    </figure>
                  </div>
                </div>
              </article>
            </div>
          </transition>
        </div>
      </section>

      <section class="card positions">
        <div class="card-head">
          <h2>Freqtrade ä»“ä½</h2>
          <button @click="fetchPositions">åˆ·æ–°</button>
        </div>
        <div v-if="!positions.length" class="empty">æš‚æ— æŒä»“</div>
        <table v-else>
          <thead>
            <tr>
              <th>ID</th>
              <th>äº¤æ˜“å¯¹</th>
              <th>æ–¹å‘</th>
              <th>çŠ¶æ€</th>
              <th>å…¥åœºä»·</th>
              <th>ç°ä»·/å¹³ä»“ä»·</th>
              <th>æ­¢æŸ</th>
              <th>æ­¢ç›ˆ</th>
              <th>æ•°é‡</th>
              <th>ä»“ä½</th>
              <th>æ æ†</th>
              <th>æ”¶ç›Š%</th>
              <th>æ”¶ç›Š(USDT)</th>
              <th>æŒä»“æ—¶é•¿</th>
              <th>å¼€ä»“æ—¶é—´</th>
              <th></th>
              <th>é…ç½®</th>
            </tr>
          </thead>
          <tbody>
            <template v-for="(pos, idx) in positions" :key="pos.trade_id">
              <tr
                v-if="shouldShowHistoryDivider(idx)"
                :key="'divider-' + pos.trade_id"
                class="history-divider"
              >
                <td colspan="17">æœ€è¿‘å¹³ä»“ (æœ€å¤š {{ historyLimit }} æ¡)</td>
              </tr>
              <tr :key="'row-' + pos.trade_id" :class="{ closed: isClosed(pos) }">
                <td>{{ pos.trade_id }}</td>
                <td>{{ pos.symbol }}</td>
                <td>{{ pos.side }}</td>
                <td>{{ formatPositionStatus(pos) }}</td>
                <td>{{ formatNumber(pos.entry_price) }}</td>
                <td>{{ formatNumber(pos.status === 'closed' ? (pos.exit_price || pos.current_price) : pos.current_price) }}</td>
                <td>{{ formatNumber(pos.stop_loss) }}</td>
                <td>{{ formatNumber(pos.take_profit) }}</td>
                <td>{{ formatNumber(pos.amount, 4) }}</td>
                <td>{{ formatNumber(pos.stake) }}</td>
                <td>{{ pos.leverage ? pos.leverage + 'x' : '-' }}</td>
                <td>{{ formatPercent(pos.pnl_ratio) }}</td>
                <td>{{ formatNumber(pos.pnl_usd) }}</td>
                <td>{{ formatDuration(pos.holding_ms) }}</td>
                <td>{{ formatTs(pos.opened_at) }}</td>
                <td>
                  <button
                    class="ghost"
                    @click="quickClose(pos)"
                    :disabled="isClosing(pos.trade_id) || isClosed(pos)"
                  >
                    {{ isClosed(pos) ? 'å·²å¹³ä»“' : (isClosing(pos.trade_id) ? 'å…³é—­ä¸­â€¦' : 'å¿«æ·å…³é—­') }}
                  </button>
                </td>
                <td>
                  <button class="ghost" @click="toggleTierEditor(pos)">
                    {{ isTierEditorOpen(pos.trade_id) ? 'æ”¶èµ·' : (isClosed(pos) ? 'æŸ¥çœ‹æ—¥å¿—' : 'é…ç½®') }}
                  </button>
                </td>
              </tr>
              <tr v-if="isTierEditorOpen(pos.trade_id)" :key="'tier-' + pos.trade_id">
                <td colspan="17" class="tier-panel" v-if="tierForms[pos.trade_id]">
                  <div class="tier-status">
                    <p><strong>Tier1:</strong> {{ formatTierStatus(pos.tier1) }}</p>
                    <p><strong>Tier2:</strong> {{ formatTierStatus(pos.tier2) }}</p>
                    <p><strong>Tier3:</strong> {{ formatTierStatus(pos.tier3) }}</p>
                    <p><strong>å‰©ä½™ä»“ä½:</strong> {{ formatPercent(pos.remaining_ratio || 0) }}</p>
                    <p v-if="pos.tier_notes"><strong>è¯´æ˜:</strong> {{ pos.tier_notes }}</p>
                  </div>
                  <div class="tier-form" v-if="!isClosed(pos)">
                    <label>Tier1 ç›®æ ‡ä»·
                      <input type="number" step="0.01" v-model.number="tierForms[pos.trade_id].tier1_target" />
                    </label>
                    <label>æ¯”ä¾‹
                      <input type="number" step="0.01" v-model.number="tierForms[pos.trade_id].tier1_ratio" />
                    </label>
                    <label>Tier2 ç›®æ ‡ä»·
                      <input type="number" step="0.01" v-model.number="tierForms[pos.trade_id].tier2_target" />
                    </label>
                    <label>æ¯”ä¾‹
                      <input type="number" step="0.01" v-model.number="tierForms[pos.trade_id].tier2_ratio" />
                    </label>
                    <label>Tier3 ç›®æ ‡ä»·
                      <input type="number" step="0.01" v-model.number="tierForms[pos.trade_id].tier3_target" />
                    </label>
                    <label>æ¯”ä¾‹
                      <input type="number" step="0.01" v-model.number="tierForms[pos.trade_id].tier3_ratio" />
                    </label>
                    <label>å¤‡æ³¨
                      <input type="text" v-model="tierForms[pos.trade_id].reason" placeholder="åŸå› ï¼ˆé€‰å¡«ï¼‰" />
                    </label>
                    <div class="tier-actions">
                      <button class="ghost" @click="toggleTierEditor(pos)">æ”¶èµ·</button>
                      <button @click="saveTierConfig(pos)" :disabled="isSavingTier(pos.trade_id)">
                        {{ isSavingTier(pos.trade_id) ? 'ä¿å­˜ä¸­â€¦' : 'ä¿å­˜é…ç½®' }}
                      </button>
                    </div>
                  </div>
                  <div class="tier-form" v-else>
                    <p>è¯¥ä»“ä½å·²å¹³ä»“ï¼Œä»…æ”¯æŒæŸ¥çœ‹æ—¥å¿—ã€‚</p>
                  </div>
                  <div class="tier-logs" :class="{ history: isClosed(pos) }">
                    <div class="tier-logs-head">
                      <h4>{{ isClosed(pos) ? 'æ‰§è¡Œæ—¥å¿—' : 'é…ç½®å†å²' }}</h4>
                      <div>
                        <template v-if="!isClosed(pos)">
                          <label>æ¡æ•°
                            <input type="number" min="1" step="10" v-model.number="tierForms[pos.trade_id].logs_limit" />
                          </label>
                        </template>
                        <button class="ghost" @click="fetchTierLogs(pos)" :disabled="isTierLogsLoading(pos.trade_id)">
                          {{ isTierLogsLoading(pos.trade_id) ? 'åŠ è½½ä¸­â€¦' : 'åˆ·æ–°' }}
                        </button>
                      </div>
                    </div>
                    <ul>
                      <li v-if="isTierLogsLoading(pos.trade_id)">åŠ è½½ä¸­â€¦</li>
                      <li v-else-if="!(tierLogs[pos.trade_id] && tierLogs[pos.trade_id].length)">æš‚æ— è®°å½•</li>
                      <li v-for="log in (tierLogs[pos.trade_id] || [])" :key="log.id">
                        {{ formatTierLog(log) }}
                      </li>
                    </ul>
                  </div>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </section>
    </main>
  </div>
  <script src="/admin/app.js" defer></script>
</body>
</html>
