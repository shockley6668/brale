<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Break A Leg Â· Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap">
    <link rel="stylesheet" href="/static/css/notion.css">
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
</head>

<body>
    <script type="text/x-template" id="app-template">
        <div class="app-frame" :class="{'is-mobile': isMobile}">
            <header class="top-nav">
                <div class="nav-main">
                    <div class="nav-logo">
                        <div class="emoji">ğŸ“˜</div>
                        <div>
                            <p class="nav-label">Break A Leg</p>
                            <h2>Live Console</h2>
                        </div>
                    </div>
                    <div class="nav-meta">æ— é‰´æƒ Â· å®ç›˜ API</div>
                    <button class="pill-btn nav-toggle" v-if="isMobile" @click="navCollapsed = !navCollapsed">
                        [[ navCollapsed ? 'å±•å¼€èœå•' : 'æ”¶èµ·èœå•' ]]
                    </button>
                                </div>
                <div class="top-nav-links" :class="{'open': !navCollapsed || !isMobile}">
                    <button class="nav-item" :class="{active: view==='desk'}" @click="switchView('desk')">Desk Â· æ€»è§ˆ</button>
                    <button class="nav-item" :class="{active: view==='decisions'}" @click="switchView('decisions')">Blue Book Â· å†³ç­–</button>
                    <button class="nav-item" :class="{active: view==='positions'}" @click="switchView('positions')">Red Book Â· ä»“ä½</button>
                    <button class="nav-item" :class="{active: view==='manualOpen'}" @click="switchView('manualOpen')">Manual Â· æ‰‹åŠ¨å¼€ä»“</button>
                    <button class="nav-item" :class="{active: view==='logs'}" @click="switchView('logs')">Logs Â· å®æ—¶</button>
                    <div class="nav-footer muted">æ•°æ®å¯†é›†ï¼Œè°¨æ…æ“ä½œ ğŸ›°</div>
                                </div>
            </header>
            <div v-if="isMobile && !navCollapsed" class="nav-backdrop" @click="navCollapsed = true"></div>

            <main class="main-panel">
                <header class="page-header">
                    <div>
                        <p class="eyebrow">[[ headline.eyebrow ]]</p>
                        <h1>[[ headline.title ]]</h1>
                        <p class="muted" v-if="headline.desc">[[ headline.desc ]]</p>
                    </div>
                    <div class="actions">
                        <button class="pill-btn" @click="refreshCurrent" :disabled="loadingAny">åˆ·æ–°</button>
                        <button class="pill-btn primary" @click="switchView('positions')">å¿«é€ŸæŸ¥çœ‹ä»“ä½</button>
                    </div>
                </header>

                <section v-if="view==='desk'" class="stack">
                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">Enabled Symbols</p>
                                <h2>å½“å‰å¯ç”¨çš„å¸ç§</h2>
                                <p class="muted">æ¥è‡ª profiles.yaml çš„è¿è¡Œé…ç½®</p>
                            </div>
                            <div class="muted">å…± [[ enabledSymbols.length ]] ä¸ª</div>
                        </div>
                        <div class="filter-tags">
                            <span class="tag active" v-for="sym in enabledSymbols" :key="sym">[[ sym ]]</span>
                            <p v-if="!enabledSymbols.length" class="muted italic">æš‚æ— é…ç½®çš„å¸ç§</p>
                        </div>
                    </div>

                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">Decision Stream</p>
                                <h2>æœ€æ–°å†³ç­–ï¼ˆå·²å¯ç”¨å¸ç§ï¼‰</h2>
                            </div>
                            <div class="muted">å®æ—¶æ‹‰å– /api/live/decisions Â· stage=final</div>
                        </div>
                        <div v-if="desk.loading" class="block-skeleton">åŠ è½½å†³ç­–æµ...</div>
                        <div v-else>
                            <div v-if="desk.error" class="callout error">[[ desk.error ]]</div>
                            <div class="capsule-list" v-if="filteredDeskDecisions.length">
                                <div class="capsule-card" v-for="item in filteredDeskDecisions" :key="item.log.id" @click="openDecision(item.log.id)">
                                    <div class="capsule-head">
                                        <div>
                                            <div class="capsule-time">[[ formatTime(item.log.ts) ]]</div>
                                            <div class="capsule-date">[[ formatDate(item.log.ts) ]]</div>
                                        </div>
                                        <span class="badge" :class="badgeClass(item.action)">[[ item.actionLabel ]]</span>
                                    </div>
                                    <div class="capsule-symbols">[[ item.log.symbols && item.log.symbols.length ? item.log.symbols.join(' / ') : 'å¤šæ ‡çš„' ]]</div>
                                    <div class="card-meta">H [[ item.log.horizon || 'N/A' ]] Â· [[ item.stepCount ]] steps</div>
                                    <p class="card-text">[[ item.summary ]]</p>
                                    <div class="capsule-footer">
                                        <div class="capsule-agents">
                                            <div class="agent-dots">
                                                <span class="agent-dot" v-for="dot in Math.min(item.providerCount,4)" :key="dot"></span>
                                                <span v-if="item.providerCount>4" class="agent-dot" :title="'+'+(item.providerCount-4)"></span>
                                            </div>
                                            <div class="capsule-agent-count">[[ item.providerCount ]] Agents</div>
                                        </div>
                                        <div :class="['capsule-status', item.hasError ? 'danger' : 'success']">
                                            [[ item.hasError ? 'âš ï¸ é£æ§å…³æ³¨' : 'ç¨³æ€é€šè¿‡' ]]
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p v-else class="muted italic">æš‚æ— å†³ç­–è®°å½•ã€‚</p>
                        </div>
                    </div>

                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">Strategy Runtime</p>
                                <h2>è¿è¡Œä¸­çš„ç­–ç•¥</h2>
                                <p class="muted">ç‚¹å‡»è·³è½¬æŸ¥çœ‹ç­–ç•¥ç›¸å…³å†³ç­–</p>
                            </div>
                        </div>
                        <div v-if="desk.loading" class="block-skeleton">åŠ è½½ç­–ç•¥...</div>
                        <div v-else>
                            <div class="provider-grid" v-if="strategyCards.length">
                                <div class="provider-card runtime-card" v-for="card in strategyCards" :key="card.symbol" @click="openStrategyConfig(card.symbol)">
                                    <div class="provider-card-header">
                                        <div>
                                            <p class="provider-name">[[ card.symbol ]]</p>
                                            <p class="provider-time muted">Profile [[ card.profileLabel || 'N/A' ]]</p>
                                        </div>
                                        <span class="badge badge-neutral">é…ç½®</span>
                                    </div>
                                    <div class="runtime-prompts compact">
                                        <div class="runtime-chip">
                                            <p class="runtime-chip-label">System</p>
                                            <p class="runtime-chip-value">[[ card.systemPromptLabel ]]</p>
                                        </div>
                                        <div class="runtime-chip">
                                            <p class="runtime-chip-label">User</p>
                                            <p class="runtime-chip-value">[[ card.userPromptLabel ]]</p>
                                        </div>
                                    </div>
                                    <div class="runtime-section">
                                        <div class="runtime-section-title">ä¸­é—´ä»¶</div>
                                        <div v-if="card.middlewareItems.length" class="runtime-list grid compact">
                                            <div class="runtime-item compact" v-for="mw in card.middlewareItems" :key="mw.key">
                                                <div class="runtime-item-head">
                                                    <span class="runtime-pill">[[ mw.name ]]</span>
                                                    <span class="runtime-meta" v-if="mw.paramsLabel">[[ mw.paramsLabel ]]</span>
                                                </div>
                                            </div>
                                        </div>
                                        <p v-else class="muted italic">æœªé…ç½®ä¸­é—´ä»¶</p>
                                    </div>
                                    <div class="runtime-section">
                                        <div class="runtime-section-title">å‡ºåœºç­–ç•¥</div>
                                        <div class="runtime-exit">
                                            <p class="runtime-exit-summary">[[ card.exitSummary || (card.strategyItems[0] && (card.strategyItems[0].desc || card.strategyItems[0].id)) || 'æœªé…ç½®' ]]</p>
                                            <div class="runtime-combos" v-if="card.exitCombos && card.exitCombos.length">
                                                <span class="runtime-pill primary" v-for="combo in card.exitCombos" :key="combo">[[ combo ]]</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p v-else class="muted italic">æš‚æ— è¿è¡Œä¸­çš„ç­–ç•¥ã€‚</p>
                        </div>
                    </div>

                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">Position Monitor</p>
                                <h2>æœ€æ–°æŒä»“</h2>
                            </div>
                            <div class="muted">æ•°æ®æ¥è‡ª /api/live/freqtrade/positions</div>
                        </div>
                        <div v-if="desk.loading" class="block-skeleton">åŠ è½½ä»“ä½...</div>
                        <div v-else>
                            <div v-if="desk.error" class="callout error">[[ desk.error ]]</div>
                            <div class="pos-grid" v-if="desk.positions.length">
                                <div class="pos-card" v-for="p in desk.positions" :key="p.trade_id" @click="openPosition(p.trade_id)">
                                    <div>
                                        <div class="pos-main-header">
                                            <div class="pos-symbol">[[ p.symbol ]]</div>
                                            <span class="pos-status" :class="statusBadgeClass(p.status)">[[ statusLabel(p.status) ]]</span>
                                        </div>
                                        <div class="pos-meta">[[ (p.side || '').toUpperCase() ]] Â· x[[ p.leverage ]]</div>
                                        <div class="pos-sub mt-2">Entry [[ formatNumber(p.entry_price) ]]</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="pos-pnl" :class="p.pnl_ratio>0 ? 'positive' : (p.pnl_ratio<0 ? 'negative' : '')">[[ formatUSD(p.pnl_usd) ]]</div>
                                        <div class="pos-sub">ROE [[ formatPercent(p.pnl_ratio) ]]</div>
                                        <div class="pos-sub mt-2">å·²å®ç° [[ formatUSD(p.realized_pnl_usd) ]]</div>
                                        <div class="pos-sub">æœªå®ç° [[ formatUSD(p.unrealized_pnl_usd) ]]</div>
                                        <div class="pos-sub mt-2">SL [[ formatNumber(p.stop_loss) ]] / TP [[ formatNumber(p.take_profit) ]]</div>
                                    </div>
                                </div>
                            </div>
                            <p v-else class="muted italic">æš‚æ— æŒä»“ã€‚</p>
                        </div>
                    </div>
                </section>

                <section v-if="view==='decisions'" class="stack">
                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">ç­›é€‰</p>
                                <h2>å¸ç§å¿«é€Ÿç­›é€‰</h2>
                                <p class="muted">ç‚¹å‡»æ ‡ç­¾å¤šé€‰ Â· é»˜è®¤åˆ—å‡ºå…¨éƒ¨</p>
                            </div>
                            <div class="muted">å…± [[ decisions.total ]] æ¡</div>
                        </div>
                    <div class="filter-tags">
                        <button class="tag" :class="{active: !decisions.symbols.length}" @click="clearSymbols">All</button>
                        <button class="tag" v-for="sym in defaultSymbols" :key="sym" :class="{active: decisions.symbols.includes(sym)}" @click="toggleSymbol(sym)">[[ sym ]]</button>
                    </div>
                </div>

                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">æ¨¡å‹è¾“å‡º</p>
                                <h2>æœ€æ–° Provider å“åº”</h2>
                                <p class="muted">æ¯ä¸ªå¸ç§ä»…å±•ç¤ºæœ€æ–°ä¸€è½®ï¼ˆstage=providerï¼‰</p>
                            </div>
                        </div>
                        <div v-if="decisions.providersLoading" class="block-skeleton">åŠ è½½ Provider è¾“å‡º...</div>
                        <div v-else>
                            <div v-if="decisions.providersError" class="callout error">[[ decisions.providersError ]]</div>
                            <div class="provider-grid" v-if="decisions.providers.length">
                                <div class="provider-card" v-for="item in decisions.providers" :key="item.id">
                                    <div class="provider-card-header">
                                        <div>
                                            <p class="provider-name">[[ item.provider ]]</p>
                                            <p class="provider-time muted">[[ formatTime(item.ts) ]] Â· [[ formatDate(item.ts) ]]</p>
                                        </div>
                                        <span class="badge" :class="badgeClass(item.action)">[[ item.actionLabel ]]</span>
                                    </div>
                                    <div class="provider-symbols">[[ item.symbolLabel ]]</div>
                                    <p class="provider-summary">[[ item.summary ]]</p>
                                </div>
                            </div>
                            <p v-else class="muted italic">æš‚æ—  Provider è¾“å‡ºã€‚</p>
                        </div>
                    </div>

                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">å†³ç­–æµ</p>
                                <h2>èƒ¶å›Šå¼å†³ç­–æµ</h2>
                                <p class="muted">æ¯ä¸ªå¸ç§æ¯é¡µå±•ç¤ºæœ€è¿‘ 2 è½® Â· ç‚¹å‡»å±•å¼€æ•´è½®æ€ç»´é“¾</p>
                            </div>
                            <div class="muted">Page [[ decisions.flowPage ]]</div>
                        </div>
                        <div v-if="decisions.loading" class="block-skeleton">åŠ è½½å†³ç­–æµ...</div>
                        <div v-else>
                            <div v-if="decisions.error" class="callout error">[[ decisions.error ]]</div>
                            <div class="capsule-list" v-if="decisions.items.length">
                                <div class="capsule-card" v-for="item in decisions.items" :key="item.log.id" @click="openDecision(item.log.id)">
                                    <div class="capsule-head">
                                        <div>
                                            <div class="capsule-time">[[ formatTime(item.log.ts) ]]</div>
                                            <div class="capsule-date">[[ formatDate(item.log.ts) ]]</div>
                                        </div>
                                        <span class="badge" :class="badgeClass(item.action)">[[ item.actionLabel ]]</span>
                                    </div>
                                    <div class="capsule-symbols">[[ item.log.symbols && item.log.symbols.length ? item.log.symbols.join(' / ') : 'å¤šæ ‡çš„' ]]</div>
                                    <div class="card-meta">H [[ item.log.horizon || 'N/A' ]] Â· [[ item.stepCount ]] steps</div>
                                    <p class="card-text">[[ item.summary ]]</p>
                                    <div class="capsule-footer">
                                        <div class="capsule-agents">
                                            <div class="agent-dots">
                                                <span class="agent-dot" v-for="dot in Math.min(item.providerCount,4)" :key="dot"></span>
                                                <span v-if="item.providerCount>4" class="agent-dot" :title="'+'+(item.providerCount-4)"></span>
                                            </div>
                                            <div class="capsule-agent-count">[[ item.providerCount ]] Agents</div>
                                        </div>
                                        <div :class="['capsule-status', item.hasError ? 'danger' : 'success']">
                                            [[ item.hasError ? 'âš ï¸ Issues' : 'Clean pass' ]]
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p v-else class="muted italic">æš‚æ— å†³ç­–è®°å½•ã€‚</p>
                        </div>
                        <div class="pager" v-if="decisionFlowCanPage">
                            <button class="pill-btn" :disabled="!decisionFlowHasPrev" @click="changeDecisionPage(-1)">ä¸Šä¸€é¡µ</button>
                            <span class="muted">ç¬¬ [[ decisions.flowPage ]] é¡µ</span>
                            <button class="pill-btn" :disabled="!decisionFlowHasNext" @click="changeDecisionPage(1)">ä¸‹ä¸€é¡µ</button>
                        </div>
                    </div>
                </section>

                <section v-if="view==='decisionDetail'" class="stack">
                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">å†³ç­–è¯¦æƒ…</p>
                                <h2>Trace #[[ decisionDetail.id ]]</h2>
                            </div>
                            <div class="actions">
                                <button class="pill-btn" @click="switchView('decisions')">è¿”å›åˆ—è¡¨</button>
                            </div>
                        </div>
                        <div v-if="decisionDetail.loading" class="block-skeleton">åŠ è½½å†³ç­–è¯¦æƒ…...</div>
                        <div v-else>
                            <div v-if="decisionDetail.error" class="callout error">[[ decisionDetail.error ]]</div>
                            <div v-if="decisionDetail.data">
                                <div class="detail-head">
                                    <div>
                                        <p class="muted">[[ decisionDetail.data.log.symbols && decisionDetail.data.log.symbols.length ? decisionDetail.data.log.symbols.join(' / ') : 'å¤šæ ‡çš„' ]]</p>
                                        <h3>[[ decisionHeadline(decisionDetail.data.log, decisionDetail.data.trace) ]]</h3>
                                        <p class="muted">H [[ decisionDetail.data.log.horizon || 'N/A' ]] Â· [[ formatDateTime(decisionDetail.data.log.ts) ]]</p>
                                    </div>
                                    <div class="badge" :class="badgeClass(decisionHeadlineAction(decisionDetail.data.log, decisionDetail.data.trace))">[[ decisionHeadline(decisionDetail.data.log, decisionDetail.data.trace) ]]</div>
                                </div>
                                <div class="notion-block mt-4">
                                    <div class="block-header">
                                        <div>
                                            <p class="notion-section-title">ç­›é€‰</p>
                                            <h3>æŒ‰é˜¶æ®µ / Provider è¿‡æ»¤</h3>
                                        </div>
                                        <div class="flex gap-2 items-center">
                                            <select class="input" v-model="decisionFilters.provider">
                                                <option value="">å…¨éƒ¨ Provider</option>
                                                <option v-for="p in decisionProviders" :key="p" :value="p">[[ p ]]</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="filter-tags">
                                        <button class="tag" :class="{active: decisionFilters.stage==='all'}" @click="setStageFilter('all')">å…¨éƒ¨</button>
                                        <button class="tag" :class="{active: decisionFilters.stage==='provider'}" @click="setStageFilter('provider')">Provider</button>
                                        <button class="tag" :class="{active: decisionFilters.stage==='agent'}" @click="setStageFilter('agent')">Agent</button>
                                        <button class="tag" :class="{active: decisionFilters.stage==='final'}" @click="setStageFilter('final')">Final</button>
                                        <button class="tag" :class="{active: decisionFilters.stage==='other'}" @click="setStageFilter('other')">Other</button>
                                    </div>
                                </div>
                                <div class="step-list" v-if="decisionDetail.data.trace && decisionDetail.data.trace.steps">
                                    <div class="step-card" v-for="(step, idx) in filteredDecisionSteps" :key="idx">
                                        <div class="step-head">
                                            <div class="step-head-left">
                                                <span class="stage-pill" :class="stageBadgeClass(step.stage)">[[ stageLabel(step.stage) ]]</span>
                                                <span class="stage-detail" v-if="stageDetail(step.stage)">[[ stageDetail(step.stage) ]]</span>
                                                <span class="step-provider">[[ step.provider_id || 'N/A' ]]</span>
                                            </div>
                                            <div class="step-head-right">[[ formatDateTime(step.ts) ]]</div>
                                        </div>
                                        <div class="step-label">LLM Output</div>
                                        <pre class="step-text">[[ step.meta_summary || step.raw_output || 'â€”' ]]</pre>
                                        <template v-if="step.images && step.images.length">
                                            <div class="step-label">Image Attachments ([[ step.images.length ]])</div>
                                            <div class="step-images">
                                                <div class="step-image-card" v-for="(img, imgIdx) in step.images" :key="img.data_uri || imgIdx">
                                                    <img class="step-image-thumb" :src="img.data_uri" :alt="img.description || ('Attachment #' + (imgIdx+1))" @click="openImagePreview(img)">
                                                    <p class="step-image-desc" v-if="(img.description || '').trim()">[[ img.description ]]</p>
                                                    <a class="step-image-link" :href="img.data_uri" target="_blank" rel="noopener">æŸ¥çœ‹åŸå›¾</a>
                                                </div>
                                            </div>
                                        </template>
                                        <div class="step-label" v-if="step.decisions && step.decisions.length">Parsed Decisions</div>
                                        <ul v-if="step.decisions && step.decisions.length" class="decision-list">
                                            <li v-for="d in step.decisions" :key="d.action">
                                                <span class="badge" :class="badgeClass(d.action)">[[ d.action.toUpperCase() ]]</span>
                                                <span class="muted ml-2">TP [[ formatNumber(d.take_profit) ]] Â· SL [[ formatNumber(d.stop_loss) ]]</span>
                                            </li>
                                        </ul>
                                        <div class="step-error" v-if="step.error">âš ï¸ [[ step.error ]]</div>

                                        <template v-if="stageLabel(step.stage)==='AGENT'">
                                            <div class="step-label mt-4">Prompts</div>
                                            <pre class="step-text">[[ mergedAgentPrompt(step) ]]</pre>
                                            <template v-for="(block, blockIdx) in extractCsvBlocks(step.user_prompt)" :key="csvBlockKey(step, blockIdx, block.tag)">
                                                <div class="csv-block">
                                                    <button class="csv-toggle" type="button" @click="toggleCsvBlock(csvBlockKey(step, blockIdx, block.tag))">
                                                        <span>[[ block.label ]] Â· [[ block.rows.length ]]è¡Œ</span>
                                                        <span>[[ isCsvExpanded(csvBlockKey(step, blockIdx, block.tag)) ? 'æ”¶èµ·' : 'å±•å¼€' ]]</span>
                                                    </button>
                                                    <div class="csv-table-wrapper" v-if="isCsvExpanded(csvBlockKey(step, blockIdx, block.tag))">
                                                        <table class="csv-table">
                                                            <thead>
                                                                <tr>
                                                                    <th v-for="(header, headerIdx) in block.headers" :key="headerIdx">[[ header ]]</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr v-for="(row, rowIdx) in block.rows" :key="rowIdx">
                                                                    <td v-for="(cell, cellIdx) in row" :key="cellIdx">[[ cell ]]</td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </template>
                                        </template>
                                    </div>
                                </div>
                                <div class="mobile-step-toggle" v-if="stepExpandAvailable">
                                    <button class="pill-btn" @click="expandMobileSteps = !expandMobileSteps">
                                        [[ expandMobileSteps ? 'æ”¶èµ·å…¨éƒ¨æ­¥éª¤' : 'å±•å¼€å…¨éƒ¨æ­¥éª¤' ]]
                                    </button>
                                </div>
                                <div class="notion-block mt-4" v-if="decisionFilters.stage!=='agent'">
                                    <div class="block-header">
                                        <div>
                                            <p class="notion-section-title">Prompts</p>
                                            <h3>Shared Prompt</h3>
                                        </div>
                                        <div class="prompt-toggle">
                                            <button class="pill-btn" :class="{primary: showSystemPrompt}" @click="showSystemPrompt = !showSystemPrompt">
                                                [[ showSystemPrompt ? 'éšè— System Prompt' : 'æ˜¾ç¤º System Prompt' ]]
                                            </button>
                                            <button class="pill-btn" :class="{primary: showUserPrompt}" @click="showUserPrompt = !showUserPrompt">
                                                [[ showUserPrompt ? 'éšè— User Prompt' : 'æ˜¾ç¤º User Prompt' ]]
                                            </button>
                                        </div>
                                    </div>
                                    <div v-if="!((sharedPrompts.systemPrompt || '').trim() || (sharedPrompts.userPrompt || '').trim())" class="muted italic">
                                        æš‚æ—  Prompt æ•°æ®ã€‚
                                    </div>
                                    <template v-else>
                                        <div class="step-label" v-if="showSystemPrompt && (sharedPrompts.systemPrompt || '').trim()">System Prompt</div>
                                        <pre class="step-text" v-if="showSystemPrompt && (sharedPrompts.systemPrompt || '').trim()">[[ sharedPrompts.systemPrompt ]]</pre>
                                        <template v-if="showUserPrompt">
                                            <div class="step-label">User Prompt</div>
                                            <pre class="step-text">[[ cleanUserPrompt(sharedPrompts.userPrompt) ]]</pre>
                                            <template v-for="(block, blockIdx) in extractCsvBlocks(sharedPrompts.userPrompt)" :key="sharedCsvBlockKey(blockIdx, block.tag)">
                                                <div class="csv-block">
                                                    <button class="csv-toggle" type="button" @click="toggleCsvBlock(sharedCsvBlockKey(blockIdx, block.tag))">
                                                        <span>[[ block.label ]] Â· [[ block.rows.length ]]è¡Œ</span>
                                                        <span>[[ isCsvExpanded(sharedCsvBlockKey(blockIdx, block.tag)) ? 'æ”¶èµ·' : 'å±•å¼€' ]]</span>
                                                    </button>
                                                    <div class="csv-table-wrapper" v-if="isCsvExpanded(sharedCsvBlockKey(blockIdx, block.tag))">
                                                        <table class="csv-table">
                                                            <thead>
                                                                <tr>
                                                                    <th v-for="(header, headerIdx) in block.headers" :key="headerIdx">[[ header ]]</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr v-for="(row, rowIdx) in block.rows" :key="rowIdx">
                                                                    <td v-for="(cell, cellIdx) in row" :key="cellIdx">[[ cell ]]</td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </template>
                                        </template>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section v-if="view==='positions'" class="stack">
                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">ç­›é€‰</p>
                                <h2>æŒä»“ç­›é€‰</h2>
                            </div>
                            <div class="flex gap-2 items-center">
                                <input class="input" placeholder="Symbolï¼Œå¦‚ BTCUSDT" v-model="positions.symbol" @keyup.enter="loadPositions(true)">
                                <button class="pill-btn" @click="loadPositions(true)">æŸ¥è¯¢</button>
                            </div>
                        </div>
                    </div>
                    <div class="notion-block">
                            <div class="block-header">
                                <div>
                                    <p class="notion-section-title">ä»“ä½åˆ—è¡¨</p>
                                    <h2>Red Book</h2>
                                </div>
                            <div class="flex gap-2 items-center">
                                <div class="muted">Page [[ positions.page ]]</div>
                                <button class="pill-btn sm"
                                        @click.stop="refreshPositionsPagePnL"
                                        :disabled="positions.loading || positions.refreshing || !positions.items.length">
                                    åˆ·æ–°ç›ˆäº
                                </button>
                            </div>
                        </div>
                        <div v-if="positions.loading" class="block-skeleton">åŠ è½½ä»“ä½...</div>
                        <div v-else>
                            <div v-if="positions.error" class="callout error">[[ positions.error ]]</div>
                            <div class="pos-grid" v-if="positions.items.length">
                                <div class="pos-card" v-for="p in positions.items" :key="p.trade_id" @click="openPosition(p.trade_id)">
                                    <div>
                                        <div class="pos-main-header">
                                            <div class="pos-symbol">[[ p.symbol ]]</div>
                                            <span class="pos-status" :class="statusBadgeClass(p.status)">[[ statusLabel(p.status) ]]</span>
                                        </div>
                                        <div class="pos-meta">[[ (p.side || '').toUpperCase() ]] Â· x[[ p.leverage ]]</div>
                                        <div class="pos-sub mt-2">Entry [[ formatNumber(p.entry_price) ]]</div>
                                    </div>
                                <div class="text-right">
                                    <div class="pos-pnl" :class="p.pnl_ratio>0 ? 'positive' : (p.pnl_ratio<0 ? 'negative' : '')">[[ formatUSD(p.pnl_usd) ]]</div>
                                    <div class="pos-sub">ROE [[ formatPercent(p.pnl_ratio) ]]</div>
                                    <div class="pos-sub mt-2">å·²å®ç° [[ formatUSD(p.realized_pnl_usd) ]]</div>
                                    <div class="pos-sub">æœªå®ç° [[ formatUSD(p.unrealized_pnl_usd) ]]</div>
                                    <div class="pos-sub mt-2">SL [[ p.stop_loss ? formatNumber(p.stop_loss) : '--' ]] / TP [[ p.take_profit ? formatNumber(p.take_profit) : '--' ]]</div>
                                    <div class="pos-sub">è· SL [[ formatPercent(stopLossDistancePct(p)) ]] Â· æœ€è¿‘è§¦å‘çº¿ [[ formatPercent(nearestTriggerDistancePct(p)) ]]</div>
                                </div>
                            </div>
                        </div>
                            <p v-else class="muted italic">æš‚æ— æŒä»“ã€‚</p>
                        </div>
                        <div class="pager" v-if="positions.total > positions.pageSize">
                            <button class="pill-btn" :disabled="positions.page<=1" @click="changePositionPage(-1)">ä¸Šä¸€é¡µ</button>
                            <span class="muted">ç¬¬ [[ positions.page ]] é¡µ</span>
                            <button class="pill-btn" :disabled="positions.page>=positionTotalPages" @click="changePositionPage(1)">ä¸‹ä¸€é¡µ</button>
                        </div>
                    </div>
                    <div class="notion-block" v-if="positions.closed && positions.closed.length">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">å·²å¹³ä»“</p>
                                <h2>Closed Positions</h2>
                            </div>
                        </div>
                        <div class="pos-grid">
                            <div class="pos-card" v-for="p in positions.closed" :key="'closed-'+p.trade_id" @click="openPosition(p.trade_id)">
                                <div>
                                    <div class="pos-main-header">
                                        <div class="pos-symbol">[[ p.symbol ]]</div>
                                        <span class="pos-status" :class="statusBadgeClass(p.status)">[[ statusLabel(p.status) ]]</span>
                                    </div>
                                    <div class="pos-meta">[[ (p.side || '').toUpperCase() ]] Â· x[[ p.leverage ]]</div>
                                    <div class="pos-sub mt-2">Entry [[ formatNumber(p.entry_price) ]] Â· Exit [[ formatNumber(p.exit_price) ]]</div>
                                    <div class="pos-sub">æŒä»“ [[ formatDuration(p.holding_ms) ]]</div>
                                </div>
                                <div class="text-right">
                                    <div class="pos-pnl" :class="p.pnl_ratio>0 ? 'positive' : (p.pnl_ratio<0 ? 'negative' : '')">
                                        [[ p.pnl_ratio>0 ? 'å·²ç›ˆåˆ© ' : (p.pnl_ratio<0 ? 'å·²äºæŸ ' : '') ]][[ formatUSD(p.pnl_usd) ]]
                                    </div>
                                    <div class="pos-sub">ROE [[ formatPercent(p.pnl_ratio) ]]</div>
                                    <div class="pos-sub mt-2">å·²å®ç° [[ formatUSD(p.realized_pnl_usd !== undefined ? p.realized_pnl_usd : p.pnl_usd) ]]</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section v-if="view==='manualOpen'" class="stack">
                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">Manual Trade</p>
                                <h2>æ‰‹åŠ¨å¼€ä»“ï¼ˆå…å®¡ï¼‰</h2>
                                <p class="muted">âš ï¸ è¯¥æ“ä½œè·³è¿‡ AI å®¡æŸ¥ï¼Œç›´æ¥æ¨é€è‡³ Freqtradeï¼Œè¯·è°¨æ…å¡«å†™æ¯ä¸€ä¸ªå‚æ•°ã€‚</p>
                            </div>
                            <div class="actions items-end">
                                <div class="text-right mr-4">
                                    <p class="muted">æœ€æ–°ä»· [[ formatNumber(manualOpen.price.last) ]]</p>
                                    <p class="muted text-xs">H [[ formatNumber(manualOpen.price.high) ]] Â· L [[ formatNumber(manualOpen.price.low) ]]</p>
                                </div>
                                <button class="pill-btn" @click="loadManualPrice" :disabled="manualOpen.loadingPrice || !manualOpen.symbol">åˆ·æ–°ä»·æ ¼</button>
                            </div>
                        </div>
                        <div class="callout warning">
                            <strong>æ— éœ€å®¡æŸ¥ï¼š</strong>è¯¥è¡¨å•ç”¨äºäººå·¥ä¿¡å·æˆ–ç´§æ€¥å¼€ä»“ï¼Œæäº¤åç«‹å³æ‰§è¡Œï¼Œç³»ç»Ÿä»…è¿›è¡ŒåŸºç¡€æ ¡éªŒï¼ˆTier æ¯”ä¾‹=100%ã€æ­¢æŸ/æ­¢ç›ˆæ–¹å‘æ­£ç¡®ï¼‰ã€‚
                        </div>
	                        <div class="grid gap-4 form-grid" style="grid-template-columns: repeat(12, minmax(0, 1fr));">
	                            <label class="form-row col-span-4">
	                                <span>äº¤æ˜“å¯¹</span>
	                                <select class="input" v-model="manualOpen.symbol">
	                                    <option v-for="sym in defaultSymbols" :value="sym" :key="sym">[[ sym ]]</option>
	                                </select>
	                            </label>
	                            <label class="form-row col-span-8">
	                                <span>Exit Plan ç­–ç•¥ç»„åˆ</span>
	                                <select class="input" v-model="manualOpen.exit_combo">
	                                    <option disabled value="">è¯·é€‰æ‹©ç­–ç•¥</option>
	                                    <option v-for="c in availableExitCombos" :value="c.key" :key="c.key">[[ c.label ]]ï¼ˆ[[ c.key ]]ï¼‰</option>
	                                </select>
	                            </label>
	                            <div class="form-row col-span-4">
	                                <span>æ–¹å‘</span>
	                                <div class="flex gap-2">
	                                    <button class="pill-btn" :class="{primary: manualOpen.side==='long'}" @click.prevent="manualOpen.side='long'">åšå¤š</button>
	                                    <button class="pill-btn danger" :class="{primary: manualOpen.side==='short'}" @click.prevent="manualOpen.side='short'">åšç©º</button>
	                                </div>
	                            </div>
	                            <label class="form-row col-span-4">
	                                <span>æ æ†</span>
	                                <input class="input" type="number" min="1" step="1" v-model.number="manualOpen.leverage">
	                            </label>
	                            <label class="form-row col-span-4">
	                                <span>å¼€ä»“ä»·æ ¼</span>
	                                <div class="flex gap-2">
	                                    <input class="input" type="number" min="0" step="0.0001" v-model.number="manualOpen.entry_price">
	                                    <button class="pill-btn" @click="fillEntryPriceFromLast" :disabled="manualOpen.loadingPrice">è·å–å½“å‰ä»·</button>
	                                </div>
	                            </label>

	                            <label class="form-row col-span-4">
	                                <span>ä»“ä½ï¼ˆUSDï¼‰</span>
	                                <input class="input" type="number" min="1" step="10" v-model.number="manualOpen.position_size_usd">
	                            </label>
	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasSlSingle">
	                                <span>æ­¢æŸç›®æ ‡ä»·</span>
	                                <input class="input" type="number" step="0.0001" v-model.number="manualOpen.stop_loss">
	                            </label>
	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasTpSingle">
	                                <span>æ­¢ç›ˆç›®æ ‡ä»·</span>
	                                <input class="input" type="number" step="0.0001" v-model.number="manualOpen.take_profit">
	                            </label>

	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasTpTiers">
	                                <span>Tier1 ç›®æ ‡</span>
	                                <input class="input" type="number" step="0.0001" v-model.number="manualOpen.tier1_target">
	                            </label>
	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasTpTiers">
	                                <span>Tier1 æ¯”ä¾‹ (0-1)</span>
	                                <input class="input" type="number" min="0" max="1" step="0.01" v-model.number="manualOpen.tier1_ratio">
	                            </label>

	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasTpTiers">
	                                <span>Tier2 ç›®æ ‡</span>
	                                <input class="input" type="number" step="0.0001" v-model.number="manualOpen.tier2_target">
	                            </label>
	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasTpTiers">
	                                <span>Tier2 æ¯”ä¾‹ (0-1)</span>
	                                <input class="input" type="number" min="0" max="1" step="0.01" v-model.number="manualOpen.tier2_ratio">
	                            </label>

	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasTpTiers">
	                                <span>Tier3 ç›®æ ‡</span>
	                                <input class="input" type="number" step="0.0001" v-model.number="manualOpen.tier3_target">
	                            </label>
	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasTpTiers">
	                                <span>Tier3 æ¯”ä¾‹ (0-1)</span>
	                                <input class="input" type="number" min="0" max="1" step="0.01" v-model.number="manualOpen.tier3_ratio">
	                            </label>

	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasSlTiers">
	                                <span>SL1 ç›®æ ‡</span>
	                                <input class="input" type="number" step="0.0001" v-model.number="manualOpen.sl_tier1_target">
	                            </label>
	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasSlTiers">
	                                <span>SL1 æ¯”ä¾‹ (0-1)</span>
	                                <input class="input" type="number" min="0" max="1" step="0.01" v-model.number="manualOpen.sl_tier1_ratio">
	                            </label>

	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasSlTiers">
	                                <span>SL2 ç›®æ ‡</span>
	                                <input class="input" type="number" step="0.0001" v-model.number="manualOpen.sl_tier2_target">
	                            </label>
	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasSlTiers">
	                                <span>SL2 æ¯”ä¾‹ (0-1)</span>
	                                <input class="input" type="number" min="0" max="1" step="0.01" v-model.number="manualOpen.sl_tier2_ratio">
	                            </label>

	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasSlTiers">
	                                <span>SL3 ç›®æ ‡</span>
	                                <input class="input" type="number" step="0.0001" v-model.number="manualOpen.sl_tier3_target">
	                            </label>
	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasSlTiers">
	                                <span>SL3 æ¯”ä¾‹ (0-1)</span>
	                                <input class="input" type="number" min="0" max="1" step="0.01" v-model.number="manualOpen.sl_tier3_ratio">
	                            </label>

                            <label class="form-row col-span-12">
                                <span>å¤‡æ³¨ / ç†ç”±ï¼ˆå†™å…¥å†³ç­–æ—¥å¿—ï¼‰</span>
	                                <input class="input" type="text" v-model="manualOpen.reason" placeholder="ä¾‹å¦‚ï¼šåŒåº•å½¢æ€ + FOMC ç©ºçª—å£ï¼Œäººå·¥ä¿¡å·">
	                            </label>
	                        </div>
	                        <div class="muted text-sm mt-4" v-if="manualOpenFlags.hasTpTiers">
	                            æ­¢ç›ˆ Tier æ¯”ä¾‹åˆè®¡ï¼š[[ formatPercent(manualTierSum) ]] ï¼ˆéœ€ç­‰äº 100%ï¼‰ã€‚å¦‚æœéœ€è¦ 33/33/34ï¼Œå¯ç›´æ¥å¡« 0.33/0.33/0.34ã€‚
	                        </div>
	                        <div class="muted text-sm mt-2" v-if="manualOpenFlags.hasSlTiers">
	                            æ­¢æŸ Tier æ¯”ä¾‹åˆè®¡ï¼š[[ formatPercent(manualSlTierSum) ]] ï¼ˆéœ€ç­‰äº 100%ï¼‰ã€‚å¦‚æœéœ€è¦ 33/33/34ï¼Œå¯ç›´æ¥å¡« 0.33/0.33/0.34ã€‚
	                        </div>
	                        <div class="callout mt-4" v-if="manualOpenPreview && manualOpenPreview.lines && manualOpenPreview.lines.length">
	                            <strong>è§¦å‘ä»·æ ¼é¢„è§ˆï¼š</strong>
	                            <div class="mt-2">
	                                <div class="flex justify-between" v-for="l in manualOpenPreview.lines" :key="l.kind+'-'+l.label">
	                                    <span>[[ l.label ]] Â· [[ l.kind ]] Â· ratio [[ formatPercent(l.ratio) ]]</span>
	                                    <span>[[ formatNumber(l.price) ]] <span class="muted text-xs" v-if="l.pct !== null && l.pct !== undefined">([[ formatPercent(l.pct) ]])</span></span>
	                                </div>
	                            </div>
	                        </div>
	                        <div class="callout error mt-4" v-if="manualOpenPreview && manualOpenPreview.errors && manualOpenPreview.errors.length">
	                            <strong>è¯·å…ˆä¿®æ­£ï¼š</strong> [[ manualOpenPreview.errors[0] ]]
	                        </div>
	                        <div class="mt-4 flex justify-between items-center">
	                            <p class="muted text-xs">æäº¤åç«‹å³æ‰§è¡Œï¼Œå»ºè®®åœ¨åˆ·æ–°å½“å‰ä»·å 30 ç§’å†…å®Œæˆã€‚</p>
	                            <button class="pill-btn primary" @click="openManualConfirm" :disabled="manualOpen.submitting">ä¸‹ä¸€æ­¥ï¼šç¡®è®¤å¼€ä»“</button>
	                        </div>
	                    </div>
	                </section>

                <section v-if="view==='positionDetail'" class="stack">
                            <div class="notion-block">
                                <div class="block-header">
                                    <div>
                                        <p class="notion-section-title">ä»“ä½è¯¦æƒ…</p>
                                        <div class="pos-main-header">
                                            <h2>Trade #[[ positionDetail.tradeId ]]</h2>
                                            <span v-if="positionDetail.data"
                                                  class="pos-status"
                                                  :class="statusBadgeClass(positionDetail.data.status)">
                                                [[ statusLabel(positionDetail.data.status) ]]
                                            </span>
                                        </div>
                                        <div class="muted" v-if="positionDetail.data && positionDetail.data.opened_at">
                                            å¼€ä»“ [[ formatDateTime(positionDetail.data.opened_at) ]]
                                            <span v-if="positionDetail.data.status==='closed' && positionDetail.data.closed_at">
                                                Â· å¹³ä»“ [[ formatDateTime(positionDetail.data.closed_at) ]]
                                            </span>
                                        </div>
                                    </div>
                                    <div class="actions">
                                        <button class="pill-btn" @click="switchView('positions')">è¿”å›åˆ—è¡¨</button>
                                        <button class="pill-btn danger" @click="forceClosePosition" :disabled="positionDetail.loading || (positionDetail.data && positionDetail.data.status==='closed')">æ‰‹åŠ¨å…¨å¹³</button>
                                    </div>
                                </div>
                                <div v-if="positionDetail.loading" class="block-skeleton">åŠ è½½ä»“ä½è¯¦æƒ…...</div>
                                <div v-else>
                                    <div v-if="positionDetail.error" class="callout error">[[ positionDetail.error ]]</div>
                                    <div v-if="positionDetail.data" class="detail-grid">
                                <div class="detail-card">
                                    <p class="muted">æ ‡çš„ / æ–¹å‘</p>
                                    <h3>[[ positionDetail.data.symbol ]] Â· [[ (positionDetail.data.side || '').toUpperCase() ]] x[[ positionDetail.data.leverage ]]</h3>
                                    <p class="muted">Entry [[ formatNumber(positionDetail.data.entry_price) ]] Â· Current [[ formatNumber(positionDetail.data.current_price) ]]</p>
                                </div>
                                <div class="detail-card">
                                    <p class="muted">çŠ¶æ€</p>
                                    <div class="flex items-center gap-2">
                                        <span class="pos-status" :class="statusBadgeClass(positionDetail.data.status)">
                                            [[ statusLabel(positionDetail.data.status) ]]
                                        </span>
                                        <span class="muted text-sm">
                                            Remaining [[ positionDetail.data.status==='closed' ? '0%' : formatPercent(positionDetail.data.remaining_ratio || 1) ]]
                                        </span>
                                    </div>
                                    <p class="muted mt-2">å·²æŒæœ‰ [[ formatDuration(positionDetail.data.holding_ms) ]]</p>
                                </div>
                                <div class="detail-card">
                                    <div class="flex justify-between items-center">
                                        <p class="muted">ç›ˆäº</p>
                                        <button class="pill-btn sm"
                                                @click="refreshPositionPnL"
                                                :disabled="positionDetail.pnlRefreshing || positionDetail.loading">
                                            åˆ·æ–°ç›ˆäº
                                        </button>
                                    </div>
                                    <h3 :class="positionDetail.data.pnl_ratio>0 ? 'text-emerald-600' : (positionDetail.data.pnl_ratio<0 ? 'text-red-600' : '')">[[ formatUSD(positionDetail.data.pnl_usd) ]]</h3>
                                    <p class="muted">ROE [[ formatPercent(positionDetail.data.pnl_ratio) ]]</p>
                                    <p class="muted">å·²å®ç° [[ formatUSD(positionDetail.data.realized_pnl_usd) ]] Â· æœªå®ç° [[ formatUSD(positionDetail.data.unrealized_pnl_usd) ]]</p>
                                </div>
                                <div class="detail-card">
                                    <p class="muted">ä»“ä½ä»·å€¼ / ä¿è¯é‡‘</p>
                                    <h3>åä¹‰ä»·å€¼ [[ formatNumber(positionDetail.data.position_value) ]] / ä¿è¯é‡‘ [[ formatNumber(positionDetail.data.stake) ]]</h3>
                                    <p class="muted">æ•°é‡ [[ formatNumber(positionDetail.data.amount) ]] / åˆå§‹ [[ formatNumber(positionDetail.data.initial_amount) ]]</p>
                                </div>
                            </div>

                            <!-- TradingView Kçº¿å›¾ -->
                            <div class="notion-block mt-4" v-if="positionDetail.data">
                                <div class="block-header">
                                    <div>
                                        <p class="notion-section-title">Kçº¿å›¾</p>
                                        <h3>TradingView Â· ç­–ç•¥æ ‡è®°</h3>
                                    </div>
                                    <div class="muted">
                                        <span class="chart-legend current">â” Current</span>
                                        <span class="chart-legend tp">â”… TP</span>
                                        <span class="chart-legend sl">â”… SL</span>
                                    </div>
                                </div>
                                <div class="tradingview-widget-container" style="height: 420px; border-radius: 8px; overflow: hidden;">
                                    <div :id="'tv-widget-'+positionDetail.tradeId" style="height: 100%;"></div>
                                </div>
                                <div class="chart-price-levels mt-2" v-if="positionDetail.data">
                                    <div class="exit-levels-wrapper compact" v-if="exitLevels.length">
                                        <div class="exit-levels-chart compact">
                                            <div class="exit-level current"
                                                 v-if="positionDetail.data.current_price"
                                                 :style="{ top: (100 - currentPricePosition) + '%' }">
                                                <span class="exit-level-label">Current</span>
                                                <div class="exit-level-line"></div>
                                                <span class="exit-level-price">[[ formatNumber(positionDetail.data.current_price) ]]</span>
                                                <span class="exit-level-indicator">â—</span>
                                            </div>
                                            <div class="exit-level"
                                                 v-for="lv in exitLevels"
                                                 :key="lv.id"
                                                 :class="[lv.type, lv.status==='triggered' ? 'triggered' : '']"
                                                 :style="{ top: (100 - lv.position) + '%' }">
                                                <span class="exit-level-label">[[ lv.label ]]</span>
                                                <div class="exit-level-line"></div>
                                                <span class="exit-level-price">[[ formatNumber(lv.price) ]]</span>
                                                <span class="exit-level-ratio" v-if="lv.ratio !== null && lv.ratio !== undefined">ratio [[ formatPercent(lv.ratio) ]]</span>
                                                <span class="exit-level-ratio" v-if="lv.hitPrice">è§¦è¾¾ [[ formatNumber(lv.hitPrice) ]]</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="chart-level-chips" v-if="chartLevelChips.length">
                                        <div class="price-level"
                                             v-for="lv in chartLevelChips"
                                             :key="lv.id"
                                             :class="[lv.type, lv.status==='triggered' ? 'triggered' : '']">
                                            <span class="level-label">[[ lv.label ]]</span>
                                            <span class="level-price">[[ formatNumber(lv.price) ]]</span>
                                            <span class="level-ratio" v-if="lv.ratio !== null && lv.ratio !== undefined">ratio [[ formatPercent(lv.ratio) ]]</span>
                                            <span class="level-ratio" v-if="lv.pct !== null && lv.pct !== undefined">Î” [[ formatPercent(lv.pct) ]]</span>
                                            <span class="level-hit" v-if="lv.hitPrice">è§¦è¾¾ [[ formatNumber(lv.hitPrice) ]]</span>
                                        </div>
                                    </div>
                                    <div class="muted text-xs" v-if="exitLevels.length">
                                        TradingView å¤–éƒ¨åµŒå…¥ä¸æ”¯æŒåœ¨å›¾å†…ç›´æ¥ç”»çº¿ï¼Œå·²åœ¨å›¾ä¸‹æ¨¡æ‹Ÿæ ‡è®°ã€‚
                                    </div>
                                </div>
                            </div>

                            <div class="notion-block mt-6" v-if="positionDetail.data">
                                <div class="block-header">
                                    <div>
                                        <p class="notion-section-title">ç­–ç•¥è°ƒæ•´</p>
                                        <h3>Update Exit Plan</h3>
                                    </div>
                                    <div class="muted">ä»…è°ƒæ•´æœªè§¦å‘æ®µä½</div>
                                </div>
                                <div v-if="positionDetail.planInstancesLoading" class="block-skeleton">åŠ è½½ç­–ç•¥...</div>
                                <div v-else>
                                    <div v-if="positionDetail.planInstancesError" class="callout error">[[ positionDetail.planInstancesError ]]</div>
                                    <div v-if="!planTierGroups.length && !atrComponents.length" class="muted italic">æš‚æ— å¯è°ƒæ•´çš„ Exit Planã€‚</div>
                                    <template v-else>
                                        <template v-if="planTierGroups.length">
                                            <div class="tier-board" v-for="group in planTierGroups" :key="group.key">
                                                <div class="tier-row">
                                                    <div class="tier-name">[[ group.label ]]</div>
                                                    <div class="tier-target muted">ç›®æ ‡ä»·</div>
                                                    <div class="tier-ratio muted">æ¯”ä¾‹</div>
                                                    <div class="tier-status muted">çŠ¶æ€</div>
                                                </div>
                                                <div class="tier-row" v-for="tier in group.tiers" :key="tier.component">
                                                    <div class="tier-name">[[ tier.name ]]</div>
                                                    <div class="tier-target">
                                                        <input class="input" type="number" step="0.0001"
                                                               :disabled="positionDetail.data.status==='closed' || !tier.editable"
                                                               v-model.number="tierEdits[tier.component].target_price">
                                                    </div>
                                                    <div class="tier-ratio">
                                                        <input class="input" type="number" min="0" max="1" step="0.01"
                                                               :disabled="positionDetail.data.status==='closed' || !tier.editable"
                                                               v-model.number="tierEdits[tier.component].ratio">
                                                    </div>
                                                    <div class="tier-status">[[ tier.statusLabel ]]</div>
                                                </div>
                                            </div>
                                        </template>

                                        <div class="tier-board mt-4" v-if="atrComponents.length">
                                            <div class="tier-row">
                                                <div class="tier-name">ATR è¿½è¸ªç»„ä»¶</div>
                                                <div class="tier-target muted">trigger_mult</div>
                                                <div class="tier-ratio muted">trail_mult</div>
                                                <div class="tier-status muted">å½“å‰(trigger/trail)</div>
                                            </div>
                                            <template v-for="item in atrComponents" :key="item.component">
                                                <div class="tier-row" v-if="atrEdits[item.component]">
                                                    <div class="tier-name">[[ item.label ]]</div>
                                                    <div class="tier-target">
                                                        <input class="input" type="number" step="0.1"
                                                               :disabled="positionDetail.data.status==='closed' || !item.editable"
                                                               v-model.number="atrEdits[item.component].trigger_multiplier">
                                                    </div>
                                                    <div class="tier-ratio">
                                                        <input class="input" type="number" step="0.1"
                                                               :disabled="positionDetail.data.status==='closed' || !item.editable"
                                                               v-model.number="atrEdits[item.component].trail_multiplier">
                                                    </div>
                                                    <div class="tier-status">[[ formatPercent(item.trigger_pct) ]] / [[ formatPercent(item.trail_pct) ]]</div>
                                                </div>
                                            </template>
                                        </div>
                                        <div class="callout warning mt-4" v-if="planEditError">[[ planEditError ]]</div>
                                        <div class="notion-block mt-4" v-if="planEditPreviewLines.length">
                                            <div class="block-header">
                                                <h3>å˜æ›´é¢„è§ˆ</h3>
                                                <div class="muted">ä»…å±•ç¤ºæœ‰å˜åŒ–çš„å­—æ®µ</div>
                                            </div>
                                            <pre class="step-text">[[ planEditPreviewLines.join('\\n') ]]</pre>
                                        </div>
                                        <div class="mt-4 flex justify-end">
                                            <button class="pill-btn primary" @click="submitTierEdits"
                                                    :disabled="tierEditsSubmitting || positionDetail.data.status==='closed' || !planEditPreviewLines.length">
                                                æäº¤ç­–ç•¥ä¿®æ”¹
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <div class="notion-block mt-6">
                                <div class="block-header">
                                    <h3>ç­–ç•¥å˜æ›´æ—¥å¿—</h3>
                                    <div class="muted">æ¥è‡ª strategy_change_log</div>
                                </div>
                                <div v-if="positionDetail.planChangesLoading" class="block-skeleton">åŠ è½½å˜æ›´æ—¥å¿—...</div>
                                <div v-else>
                                    <div v-if="!positionDetail.planChanges.length" class="muted italic">æš‚æ— å˜æ›´æ—¥å¿—</div>
                                    <div class="log-list" v-else>
                                        <div class="plan-change-group" v-for="g in planChangeGroups" :key="g.key">
                                            <div class="plan-change-head">
                                                <div>
                                                    <div class="plan-change-time">[[ formatDateTime(g.createdAt) ]]</div>
                                                    <div class="muted text-xs">
                                                        [[ g.sourceLabel ]]
                                                        <span v-if="g.traceShort"> Â· trace [[ g.traceShort ]]</span>
                                                    </div>
                                                </div>
                                                <div class="muted text-xs">[[ (g.logs && g.logs.length) || 0 ]] æ¡</div>
                                            </div>
                                            <ul class="plan-change-lines" v-if="g.lines && g.lines.length">
                                                <li v-for="(line, idx) in g.lines" :key="g.key+'-'+idx">[[ line ]]</li>
                                            </ul>
                                            <div class="muted italic" v-else>æš‚æ— å¯å±•ç¤ºå†…å®¹</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="notion-block mt-6">
                                <div class="block-header">
                                    <h3>äº‹ä»¶æµæ°´</h3>
                                    <div class="muted">æ¥è‡ª trade_operation_log</div>
                                </div>
                                <div v-if="positionDetail.tradeEventsLoading" class="block-skeleton">åŠ è½½äº‹ä»¶...</div>
                                <div v-else>
                                    <div v-if="positionDetail.tradeEventsError" class="callout error">[[ positionDetail.tradeEventsError ]]</div>
                                    <div v-if="!positionDetail.tradeEvents.length" class="muted italic">æš‚æ— äº‹ä»¶</div>
                                    <div class="log-list" v-else>
                                        <div class="log-row" v-for="ev in positionDetail.tradeEvents" :key="ev.timestamp">
                                            <div>[[ formatDateTime(ev.timestamp) ]]</div>
                                            <div class="muted">[[ operationLabel(ev.operation) ]]</div>
                                            <div class="muted">[[ (ev.details && (ev.details.reason || ev.details.event_type)) || '' ]]</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section v-if="view==='logs'" class="stack">
                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">å®æ—¶æ—¥å¿—</p>
                                <h2>Logs</h2>
                                <p class="muted">æ‹‰å–åç«¯ log_path/llm_log_path æœ€è¿‘è‹¥å¹²è¡Œ</p>
                            </div>
                            <div class="actions">
                                <select class="input" v-model="logs.name" @change="loadLogs(true)">
                                    <option v-for="name in logs.available" :key="name" :value="name">[[ name ]]</option>
                                </select>
                                <button class="pill-btn" @click="loadLogs(true)" :disabled="logs.loading">åˆ·æ–°</button>
                            </div>
                        </div>
                        <div v-if="logs.loading" class="block-skeleton">åŠ è½½æ—¥å¿—...</div>
                        <div v-else>
                            <div v-if="logs.error" class="callout error">[[ logs.error ]]</div>
                            <div class="log-view" v-if="logs.lines.length">
                                <div class="log-line" v-for="(line, idx) in logs.lines" :key="idx">[[ line ]]</div>
                            </div>
                            <p v-else class="muted italic">æš‚æ— æ—¥å¿—å†…å®¹</p>
                        </div>
                    </div>
                </section>
            </main>
	        </div>
	        <div v-if="toast.message" class="toast" :class="toast.type">[[ toast.message ]]</div>
	        <div v-if="manualOpen.showConfirm" class="image-modal" @click.self="manualOpen.showConfirm=false">
	            <div class="image-modal-content">
	                <div>
	                    <p class="notion-section-title">Manual Trade</p>
	                    <h3>ç¡®è®¤å¼€ä»“</h3>
	                    <p class="muted text-sm">å°†è·³è¿‡ AI å®¡æŸ¥ï¼Œç›´æ¥æ¨é€è‡³ Freqtradeã€‚</p>
	                </div>
	                <div class="callout">
	                    <div class="flex justify-between">
	                        <span><strong>Symbol</strong> [[ manualOpenPreview.symbol ]]</span>
	                        <span><strong>Side</strong> [[ (manualOpenPreview.side || '').toUpperCase() ]]</span>
	                    </div>
	                    <div class="flex justify-between mt-2">
	                        <span><strong>Leverage</strong> x[[ manualOpen.leverage ]]</span>
	                        <span><strong>Size</strong> [[ formatNumber(manualOpen.position_size_usd) ]] USD</span>
	                    </div>
	                    <div class="flex justify-between mt-2">
	                        <span><strong>Entry</strong> [[ formatNumber(manualOpen.entry_price) ]]</span>
	                        <span><strong>Strategy</strong> [[ manualOpenPreview.comboLabel ]]</span>
	                    </div>
	                    <div class="mt-3" v-if="manualOpenPreview.lines && manualOpenPreview.lines.length">
	                        <div class="muted text-xs mb-2">è§¦å‘ä»·æ ¼æ˜ç»†</div>
	                        <div class="flex justify-between" v-for="l in manualOpenPreview.lines" :key="'confirm-'+l.kind+'-'+l.label">
	                            <span>[[ l.label ]] Â· [[ l.kind ]] Â· ratio [[ formatPercent(l.ratio) ]]</span>
	                            <span>[[ formatNumber(l.price) ]] <span class="muted text-xs" v-if="l.pct !== null && l.pct !== undefined">([[ formatPercent(l.pct) ]])</span></span>
	                        </div>
	                    </div>
	                    <div class="mt-3" v-if="manualOpen.reason">
	                        <div class="muted text-xs mb-2">å¤‡æ³¨</div>
	                        <div>[[ manualOpen.reason ]]</div>
	                    </div>
	                </div>
	                <div class="image-modal-actions">
	                    <button class="pill-btn" @click="manualOpen.showConfirm=false">å–æ¶ˆ</button>
	                    <button class="pill-btn primary" @click="confirmManualOpen" :disabled="manualOpen.submitting">ç¡®è®¤å¼€ä»“</button>
	                </div>
	            </div>
	        </div>
	        <div v-if="imagePreview.visible" class="image-modal" @click.self="closeImagePreview">
	            <div class="image-modal-content">
	                <img :src="imagePreview.src" :alt="imagePreview.desc || 'LLM Attachment'">
	                <p class="image-modal-desc" v-if="imagePreview.desc">[[ imagePreview.desc ]]</p>
                <div class="image-modal-actions">
                    <a class="pill-btn" :href="imagePreview.src" target="_blank" rel="noopener">åœ¨æ–°æ ‡ç­¾æ‰“å¼€</a>
                    <button class="pill-btn" @click="closeImagePreview">å…³é—­</button>
                </div>
            </div>
        </div>
    </script>

    <div id="app"></div>

    <script>
        window.__APP_INIT__ = {
            view: "{{ if .InitialView }}{{ .InitialView }}{{ else }}desk{{ end }}",
            decisionId: {{ if .DecisionID }}{{ .DecisionID }}{{ else }}null{{ end }},
        traceId: {{ if .TraceID }}{{ printf "%q" .TraceID }}{{ else }}null{{ end }},
        tradeId: {{ if .TradeID }}{{ .TradeID }}{{ else }}null{{ end }},
        symbol: {{ if .Symbol }}{{ printf "%q" .Symbol }}{{ else }}""{{ end }},
        selectedSymbols: {{ if .SelectedSymbols }}{{ toJSON .SelectedSymbols }}{{ else }}[]{{ end }},
        defaultSymbols: {{ toJSON .DefaultSymbols }},
        symbolDetails: {{ toJSON .SymbolDetails }},
        };
    </script>
    <script src="/static/js/admin-app.js"></script>
</body>

</html>
