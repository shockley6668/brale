<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Break A Leg Â· Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap">
    <link rel="stylesheet" href="/static/css/notion.css">
</head>
<body>
    <script type="text/x-template" id="app-template">
        <div class="app-frame" :class="{'is-mobile': isMobile}">
            <header class="top-nav">
                <div class="nav-main">
                    <div class="nav-logo">
                        <div class="emoji">ğŸ“˜</div>
                        <div>
                            <p class="nav-label">Break A Leg</p>
                            <h2>Live Console</h2>
                        </div>
                    </div>
                    <div class="nav-meta">æ— é‰´æƒ Â· å®ç›˜ API</div>
                    <button class="pill-btn nav-toggle" v-if="isMobile" @click="navCollapsed = !navCollapsed">
                        [[ navCollapsed ? 'å±•å¼€èœå•' : 'æ”¶èµ·èœå•' ]]
                    </button>
                                </div>
                <div class="top-nav-links" :class="{'open': !navCollapsed || !isMobile}">
                    <button class="nav-item" :class="{active: view==='desk'}" @click="switchView('desk')">Desk Â· æ€»è§ˆ</button>
                    <button class="nav-item" :class="{active: view==='decisions'}" @click="switchView('decisions')">Blue Book Â· å†³ç­–</button>
                    <button class="nav-item" :class="{active: view==='positions'}" @click="switchView('positions')">Red Book Â· ä»“ä½</button>
                    <button class="nav-item" :class="{active: view==='manualOpen'}" @click="switchView('manualOpen')">Manual Â· æ‰‹åŠ¨å¼€ä»“</button>
                    <button class="nav-item" :class="{active: view==='logs'}" @click="switchView('logs')">Logs Â· å®æ—¶</button>
                    <div class="nav-footer muted">æ•°æ®å¯†é›†ï¼Œè°¨æ…æ“ä½œ ğŸ›°</div>
                                </div>
            </header>
            <div v-if="isMobile && !navCollapsed" class="nav-backdrop" @click="navCollapsed = true"></div>

            <main class="main-panel">
                <header class="page-header">
                    <div>
                        <p class="eyebrow">[[ headline.eyebrow ]]</p>
                        <h1>[[ headline.title ]]</h1>
                        <p class="muted" v-if="headline.desc">[[ headline.desc ]]</p>
                    </div>
                    <div class="actions">
                        <button class="pill-btn" @click="refreshCurrent" :disabled="loadingAny">åˆ·æ–°</button>
                        <button class="pill-btn primary" @click="switchView('positions')">å¿«é€ŸæŸ¥çœ‹ä»“ä½</button>
                    </div>
                </header>

                <section v-if="view==='desk'" class="stack">
                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">Decision Stream</p>
                                <h2>æœ€æ–°å†³ç­–èƒ¶å›Š</h2>
                            </div>
                            <div class="muted">å®æ—¶æ‹‰å– /api/live/decisions Â· stage=final</div>
                        </div>
                        <div v-if="desk.loading" class="block-skeleton">åŠ è½½å†³ç­–æµ...</div>
                        <div v-else>
                            <div v-if="desk.error" class="callout error">[[ desk.error ]]</div>
                            <div class="capsule-list" v-if="desk.decisions.length">
                                <div class="capsule-card" v-for="item in desk.decisions" :key="item.log.id" @click="openDecision(item.log.id)">
                                    <div class="capsule-head">
                                        <div>
                                            <div class="capsule-time">[[ formatTime(item.log.ts) ]]</div>
                                            <div class="capsule-date">[[ formatDate(item.log.ts) ]]</div>
                                        </div>
                                        <span class="badge" :class="badgeClass(item.action)">[[ item.actionLabel ]]</span>
                                    </div>
                                    <div class="capsule-symbols">[[ item.log.symbols && item.log.symbols.length ? item.log.symbols.join(' / ') : 'å¤šæ ‡çš„' ]]</div>
                                    <div class="card-meta">H [[ item.log.horizon || 'N/A' ]] Â· [[ item.stepCount ]] steps</div>
                                    <p class="card-text">[[ item.summary ]]</p>
                                    <div class="capsule-footer">
                                        <div class="capsule-agents">
                                            <div class="agent-dots">
                                                <span class="agent-dot" v-for="dot in Math.min(item.providerCount,4)" :key="dot"></span>
                                                <span v-if="item.providerCount>4" class="agent-dot" :title="'+'+(item.providerCount-4)"></span>
                                            </div>
                                            <div class="capsule-agent-count">[[ item.providerCount ]] Agents</div>
                                        </div>
                                        <div :class="['capsule-status', item.hasError ? 'danger' : 'success']">
                                            [[ item.hasError ? 'âš ï¸ é£æ§å…³æ³¨' : 'ç¨³æ€é€šè¿‡' ]]
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p v-else class="muted italic">æš‚æ— å†³ç­–è®°å½•ã€‚</p>
                        </div>
                    </div>

                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">Position Monitor</p>
                                <h2>æœ€æ–°æŒä»“</h2>
                            </div>
                            <div class="muted">æ•°æ®æ¥è‡ª /api/live/freqtrade/positions</div>
                        </div>
                        <div v-if="desk.loading" class="block-skeleton">åŠ è½½ä»“ä½...</div>
                        <div v-else>
                            <div v-if="desk.error" class="callout error">[[ desk.error ]]</div>
                            <div class="pos-grid" v-if="desk.positions.length">
                                <div class="pos-card" v-for="p in desk.positions" :key="p.trade_id" @click="openPosition(p.trade_id)">
                                    <div>
                                        <div class="pos-main-header">
                                            <div class="pos-symbol">[[ p.symbol ]]</div>
                                            <span class="pos-status" :class="statusBadgeClass(p.status)">[[ statusLabel(p.status) ]]</span>
                                        </div>
                                        <div class="pos-meta">[[ (p.side || '').toUpperCase() ]] Â· x[[ p.leverage ]]</div>
                                        <div class="pos-sub mt-2">Entry [[ formatNumber(p.entry_price) ]]</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="pos-pnl" :class="p.pnl_ratio>0 ? 'positive' : (p.pnl_ratio<0 ? 'negative' : '')">[[ formatUSD(p.pnl_usd) ]]</div>
                                        <div class="pos-sub">ROE [[ formatPercent(p.pnl_ratio) ]]</div>
                                        <div class="pos-sub mt-2">å·²å®ç° [[ formatUSD(p.realized_pnl_usd) ]]</div>
                                        <div class="pos-sub">æœªå®ç° [[ formatUSD(p.unrealized_pnl_usd) ]]</div>
                                        <div class="pos-sub mt-2">SL [[ formatNumber(p.stop_loss) ]] / TP [[ formatNumber(p.take_profit) ]]</div>
                                    </div>
                                </div>
                            </div>
                            <p v-else class="muted italic">æš‚æ— æŒä»“ã€‚</p>
                        </div>
                    </div>
                </section>

                <section v-if="view==='decisions'" class="stack">
                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">ç­›é€‰</p>
                                <h2>å¸ç§å¿«é€Ÿç­›é€‰</h2>
                                <p class="muted">ç‚¹å‡»æ ‡ç­¾å¤šé€‰ Â· é»˜è®¤åˆ—å‡ºå…¨éƒ¨</p>
                            </div>
                            <div class="muted">å…± [[ decisions.total ]] æ¡</div>
                        </div>
                    <div class="filter-tags">
                        <button class="tag" :class="{active: !decisions.symbols.length}" @click="clearSymbols">All</button>
                        <button class="tag" v-for="sym in defaultSymbols" :key="sym" :class="{active: decisions.symbols.includes(sym)}" @click="toggleSymbol(sym)">[[ sym ]]</button>
                    </div>
                </div>

                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">æ¨¡å‹è¾“å‡º</p>
                                <h2>æœ€æ–° Provider å“åº”</h2>
                                <p class="muted">æ¥è‡ª stage=provider çš„æœ€è¿‘è‹¥å¹²æ¡è®°å½•</p>
                            </div>
                        </div>
                        <div v-if="decisions.providersLoading" class="block-skeleton">åŠ è½½ Provider è¾“å‡º...</div>
                        <div v-else>
                            <div v-if="decisions.providersError" class="callout error">[[ decisions.providersError ]]</div>
                            <div class="provider-grid" v-if="decisions.providers.length">
                                <div class="provider-card" v-for="item in decisions.providers" :key="item.id">
                                    <div class="provider-card-header">
                                        <div>
                                            <p class="provider-name">[[ item.provider ]]</p>
                                            <p class="provider-time muted">[[ formatTime(item.ts) ]] Â· [[ formatDate(item.ts) ]]</p>
                                        </div>
                                        <span class="badge" :class="badgeClass(item.action)">[[ item.actionLabel ]]</span>
                                    </div>
                                    <div class="provider-symbols">[[ item.symbolLabel ]]</div>
                                    <p class="provider-summary">[[ item.summary ]]</p>
                                </div>
                            </div>
                            <p v-else class="muted italic">æš‚æ—  Provider è¾“å‡ºã€‚</p>
                        </div>
                    </div>

                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">å†³ç­–æµ</p>
                                <h2>èƒ¶å›Šå¼å†³ç­–æµ</h2>
                                <p class="muted">ç‚¹å‡»å±•å¼€æ•´è½®æ€ç»´é“¾</p>
                            </div>
                            <div class="muted">Page [[ decisions.page ]]</div>
                        </div>
                        <div v-if="decisions.loading" class="block-skeleton">åŠ è½½å†³ç­–æµ...</div>
                        <div v-else>
                            <div v-if="decisions.error" class="callout error">[[ decisions.error ]]</div>
                            <div class="capsule-list" v-if="decisions.items.length">
                                <div class="capsule-card" v-for="item in decisions.items" :key="item.log.id" @click="openDecision(item.log.id)">
                                    <div class="capsule-head">
                                        <div>
                                            <div class="capsule-time">[[ formatTime(item.log.ts) ]]</div>
                                            <div class="capsule-date">[[ formatDate(item.log.ts) ]]</div>
                                        </div>
                                        <span class="badge" :class="badgeClass(item.action)">[[ item.actionLabel ]]</span>
                                    </div>
                                    <div class="capsule-symbols">[[ item.log.symbols && item.log.symbols.length ? item.log.symbols.join(' / ') : 'å¤šæ ‡çš„' ]]</div>
                                    <div class="card-meta">H [[ item.log.horizon || 'N/A' ]] Â· [[ item.stepCount ]] steps</div>
                                    <p class="card-text">[[ item.summary ]]</p>
                                    <div class="capsule-footer">
                                        <div class="capsule-agents">
                                            <div class="agent-dots">
                                                <span class="agent-dot" v-for="dot in Math.min(item.providerCount,4)" :key="dot"></span>
                                                <span v-if="item.providerCount>4" class="agent-dot" :title="'+'+(item.providerCount-4)"></span>
                                            </div>
                                            <div class="capsule-agent-count">[[ item.providerCount ]] Agents</div>
                                        </div>
                                        <div :class="['capsule-status', item.hasError ? 'danger' : 'success']">
                                            [[ item.hasError ? 'âš ï¸ Issues' : 'Clean pass' ]]
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p v-else class="muted italic">æš‚æ— å†³ç­–è®°å½•ã€‚</p>
                        </div>
                        <div class="pager" v-if="decisions.total > decisions.pageSize">
                            <button class="pill-btn" :disabled="decisions.page<=1" @click="changeDecisionPage(-1)">ä¸Šä¸€é¡µ</button>
                            <span class="muted">ç¬¬ [[ decisions.page ]] é¡µ</span>
                            <button class="pill-btn" :disabled="decisions.page>=decisionTotalPages" @click="changeDecisionPage(1)">ä¸‹ä¸€é¡µ</button>
                        </div>
                    </div>
                </section>

                <section v-if="view==='decisionDetail'" class="stack">
                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">å†³ç­–è¯¦æƒ…</p>
                                <h2>Trace #[[ decisionDetail.id ]]</h2>
                            </div>
                            <div class="actions">
                                <button class="pill-btn" @click="switchView('decisions')">è¿”å›åˆ—è¡¨</button>
                            </div>
                        </div>
                        <div v-if="decisionDetail.loading" class="block-skeleton">åŠ è½½å†³ç­–è¯¦æƒ…...</div>
                        <div v-else>
                            <div v-if="decisionDetail.error" class="callout error">[[ decisionDetail.error ]]</div>
                            <div v-if="decisionDetail.data">
                                <div class="detail-head">
                                    <div>
                                        <p class="muted">[[ decisionDetail.data.log.symbols && decisionDetail.data.log.symbols.length ? decisionDetail.data.log.symbols.join(' / ') : 'å¤šæ ‡çš„' ]]</p>
                                        <h3>[[ decisionHeadline(decisionDetail.data.log, decisionDetail.data.trace) ]]</h3>
                                        <p class="muted">H [[ decisionDetail.data.log.horizon || 'N/A' ]] Â· [[ formatDateTime(decisionDetail.data.log.ts) ]]</p>
                                    </div>
                                    <div class="badge" :class="badgeClass(decisionHeadlineAction(decisionDetail.data.log, decisionDetail.data.trace))">[[ decisionHeadline(decisionDetail.data.log, decisionDetail.data.trace) ]]</div>
                                </div>
                                <div class="notion-block mt-4">
                                    <div class="block-header">
                                        <div>
                                            <p class="notion-section-title">ç­›é€‰</p>
                                            <h3>æŒ‰é˜¶æ®µ / Provider è¿‡æ»¤</h3>
                                        </div>
                                        <div class="flex gap-2 items-center">
                                            <select class="input" v-model="decisionFilters.provider">
                                                <option value="">å…¨éƒ¨ Provider</option>
                                                <option v-for="p in decisionProviders" :key="p" :value="p">[[ p ]]</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="filter-tags">
                                        <button class="tag" :class="{active: decisionFilters.stage==='all'}" @click="setStageFilter('all')">å…¨éƒ¨</button>
                                        <button class="tag" :class="{active: decisionFilters.stage==='provider'}" @click="setStageFilter('provider')">Provider</button>
                                        <button class="tag" :class="{active: decisionFilters.stage==='agent'}" @click="setStageFilter('agent')">Agent</button>
                                        <button class="tag" :class="{active: decisionFilters.stage==='final'}" @click="setStageFilter('final')">Final</button>
                                        <button class="tag" :class="{active: decisionFilters.stage==='other'}" @click="setStageFilter('other')">Other</button>
                                    </div>
                                    <div class="prompt-toggle">
                                        <button class="pill-btn" :class="{primary: showSystemPrompt}" @click="showSystemPrompt = !showSystemPrompt">
                                            [[ showSystemPrompt ? 'éšè— System Prompt' : 'æ˜¾ç¤º System Prompt' ]]
                                        </button>
                                        <button class="pill-btn" :class="{primary: showUserPrompt}" @click="showUserPrompt = !showUserPrompt">
                                            [[ showUserPrompt ? 'éšè— User Prompt' : 'æ˜¾ç¤º User Prompt' ]]
                                        </button>
                                    </div>
                                </div>
                                <div class="step-list" v-if="decisionDetail.data.trace && decisionDetail.data.trace.steps">
                                    <div class="step-card" v-for="(step, idx) in filteredDecisionSteps" :key="idx">
                                        <div class="step-head">
                                            <div class="step-head-left">
                                                <span class="stage-pill" :class="stageBadgeClass(step.stage)">[[ stageLabel(step.stage) ]]</span>
                                                <span class="stage-detail" v-if="stageDetail(step.stage)">[[ stageDetail(step.stage) ]]</span>
                                                <span class="step-provider">[[ step.provider_id || 'N/A' ]]</span>
                                            </div>
                                            <div class="step-head-right">[[ formatDateTime(step.ts) ]]</div>
                                        </div>
                                        <div class="step-label" v-if="showSystemPrompt && (step.system_prompt || '').trim()">System Prompt</div>
                                        <pre class="step-text" v-if="showSystemPrompt && (step.system_prompt || '').trim()">[[ step.system_prompt ]]</pre>
                                        <div class="step-label" v-if="showUserPrompt">User Prompt</div>
                                        <pre class="step-text" v-if="showUserPrompt">[[ step.user_prompt || 'â€”' ]]</pre>
                                        <template v-if="step.images && step.images.length">
                                            <div class="step-label">Image Attachments ([[ step.images.length ]])</div>
                                            <div class="step-images">
                                                <div class="step-image-card" v-for="(img, imgIdx) in step.images" :key="img.data_uri || imgIdx">
                                                    <img class="step-image-thumb" :src="img.data_uri" :alt="img.description || ('Attachment #' + (imgIdx+1))" @click="openImagePreview(img)">
                                                    <p class="step-image-desc" v-if="(img.description || '').trim()">[[ img.description ]]</p>
                                                    <a class="step-image-link" :href="img.data_uri" target="_blank" rel="noopener">æŸ¥çœ‹åŸå›¾</a>
                                                </div>
                                            </div>
                                        </template>
                                        <div class="step-label">LLM Output</div>
                                        <pre class="step-text">[[ step.meta_summary || step.raw_output || 'â€”' ]]</pre>
                                        <div class="step-label" v-if="step.decisions && step.decisions.length">Parsed Decisions</div>
                                        <ul v-if="step.decisions && step.decisions.length" class="decision-list">
                                            <li v-for="d in step.decisions" :key="d.action">
                                                <span class="badge" :class="badgeClass(d.action)">[[ d.action.toUpperCase() ]]</span>
                                                <span class="muted ml-2">TP [[ formatNumber(d.take_profit) ]] Â· SL [[ formatNumber(d.stop_loss) ]]</span>
                                            </li>
                                        </ul>
                                        <div class="step-error" v-if="step.error">âš ï¸ [[ step.error ]]</div>
                                    </div>
                                </div>
                                <div class="mobile-step-toggle" v-if="stepExpandAvailable">
                                    <button class="pill-btn" @click="expandMobileSteps = !expandMobileSteps">
                                        [[ expandMobileSteps ? 'æ”¶èµ·å…¨éƒ¨æ­¥éª¤' : 'å±•å¼€å…¨éƒ¨æ­¥éª¤' ]]
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section v-if="view==='positions'" class="stack">
                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">ç­›é€‰</p>
                                <h2>æŒä»“ç­›é€‰</h2>
                            </div>
                            <div class="flex gap-2 items-center">
                                <input class="input" placeholder="Symbolï¼Œå¦‚ BTCUSDT" v-model="positions.symbol" @keyup.enter="loadPositions(true)">
                                <button class="pill-btn" @click="loadPositions(true)">æŸ¥è¯¢</button>
                            </div>
                        </div>
                    </div>
                    <div class="notion-block">
                            <div class="block-header">
                                <div>
                                    <p class="notion-section-title">ä»“ä½åˆ—è¡¨</p>
                                    <h2>Red Book</h2>
                                </div>
                            <div class="muted">Page [[ positions.page ]]</div>
                        </div>
                        <div v-if="positions.loading" class="block-skeleton">åŠ è½½ä»“ä½...</div>
                        <div v-else>
                            <div v-if="positions.error" class="callout error">[[ positions.error ]]</div>
                            <div class="pos-grid" v-if="positions.items.length">
                                <div class="pos-card" v-for="p in positions.items" :key="p.trade_id" @click="openPosition(p.trade_id)">
                                    <div>
                                        <div class="pos-main-header">
                                            <div class="pos-symbol">[[ p.symbol ]]</div>
                                            <span class="pos-status" :class="statusBadgeClass(p.status)">[[ statusLabel(p.status) ]]</span>
                                        </div>
                                        <div class="pos-meta">[[ (p.side || '').toUpperCase() ]] Â· x[[ p.leverage ]]</div>
                                        <div class="pos-sub mt-2">Entry [[ formatNumber(p.entry_price) ]]</div>
                                    </div>
                                <div class="text-right">
                                    <div class="pos-pnl" :class="p.pnl_ratio>0 ? 'positive' : (p.pnl_ratio<0 ? 'negative' : '')">[[ formatUSD(p.pnl_usd) ]]</div>
                                    <div class="pos-sub">ROE [[ formatPercent(p.pnl_ratio) ]]</div>
                                    <div class="pos-sub mt-2">å·²å®ç° [[ formatUSD(p.realized_pnl_usd) ]]</div>
                                    <div class="pos-sub">æœªå®ç° [[ formatUSD(p.unrealized_pnl_usd) ]]</div>
                                    <div class="pos-sub mt-2">SL [[ formatNumber(p.stop_loss) ]] / TP [[ formatNumber(p.take_profit) ]]</div>
                                </div>
                            </div>
                        </div>
                            <p v-else class="muted italic">æš‚æ— æŒä»“ã€‚</p>
                        </div>
                        <div class="pager" v-if="positions.total > positions.pageSize">
                            <button class="pill-btn" :disabled="positions.page<=1" @click="changePositionPage(-1)">ä¸Šä¸€é¡µ</button>
                            <span class="muted">ç¬¬ [[ positions.page ]] é¡µ</span>
                            <button class="pill-btn" :disabled="positions.page>=positionTotalPages" @click="changePositionPage(1)">ä¸‹ä¸€é¡µ</button>
                        </div>
                    </div>
                    <div class="notion-block" v-if="positions.closed && positions.closed.length">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">å·²å¹³ä»“</p>
                                <h2>Closed Positions</h2>
                            </div>
                        </div>
                        <div class="pos-grid">
                            <div class="pos-card" v-for="p in positions.closed" :key="'closed-'+p.trade_id">
                                <div>
                                    <div class="pos-main-header">
                                        <div class="pos-symbol">[[ p.symbol ]]</div>
                                        <span class="pos-status" :class="statusBadgeClass(p.status)">[[ statusLabel(p.status) ]]</span>
                                    </div>
                                    <div class="pos-meta">[[ (p.side || '').toUpperCase() ]] Â· x[[ p.leverage ]]</div>
                                    <div class="pos-sub mt-2">Entry [[ formatNumber(p.entry_price) ]] Â· Exit [[ formatNumber(p.exit_price) ]]</div>
                                </div>
                                <div class="text-right">
                                    <div class="pos-pnl" :class="p.pnl_ratio>0 ? 'positive' : (p.pnl_ratio<0 ? 'negative' : '')">
                                        [[ p.pnl_ratio>0 ? 'å·²ç›ˆåˆ© ' : (p.pnl_ratio<0 ? 'å·²äºæŸ ' : '') ]][[ formatUSD(p.pnl_usd) ]]
                                    </div>
                                    <div class="pos-sub">ROE [[ formatPercent(p.pnl_ratio) ]]</div>
                                    <div class="pos-sub mt-2">å·²å®ç° [[ formatUSD(p.realized_pnl_usd !== undefined ? p.realized_pnl_usd : p.pnl_usd) ]]</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section v-if="view==='manualOpen'" class="stack">
                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">Manual Trade</p>
                                <h2>æ‰‹åŠ¨å¼€ä»“ï¼ˆå…å®¡ï¼‰</h2>
                                <p class="muted">âš ï¸ è¯¥æ“ä½œè·³è¿‡ AI å®¡æŸ¥ï¼Œç›´æ¥æ¨é€è‡³ Freqtradeï¼Œè¯·è°¨æ…å¡«å†™æ¯ä¸€ä¸ªå‚æ•°ã€‚</p>
                            </div>
                            <div class="actions items-end">
                                <div class="text-right mr-4">
                                    <p class="muted">æœ€æ–°ä»· [[ formatNumber(manualOpen.price.last) ]]</p>
                                    <p class="muted text-xs">H [[ formatNumber(manualOpen.price.high) ]] Â· L [[ formatNumber(manualOpen.price.low) ]]</p>
                                </div>
                                <button class="pill-btn" @click="loadManualPrice" :disabled="manualOpen.loadingPrice || !manualOpen.symbol">åˆ·æ–°ä»·æ ¼</button>
                            </div>
                        </div>
                        <div class="callout warning">
                            <strong>æ— éœ€å®¡æŸ¥ï¼š</strong>è¯¥è¡¨å•ç”¨äºäººå·¥ä¿¡å·æˆ–ç´§æ€¥å¼€ä»“ï¼Œæäº¤åç«‹å³æ‰§è¡Œï¼Œç³»ç»Ÿä»…è¿›è¡ŒåŸºç¡€æ ¡éªŒï¼ˆTier æ¯”ä¾‹=100%ã€æ­¢æŸ/æ­¢ç›ˆæ–¹å‘æ­£ç¡®ï¼‰ã€‚
                        </div>
                        <div class="grid gap-4 form-grid" style="grid-template-columns: repeat(12, minmax(0, 1fr));">
                            <label class="form-row col-span-4">
                                <span>äº¤æ˜“å¯¹</span>
                                <select class="input" v-model="manualOpen.symbol">
                                    <option v-for="sym in defaultSymbols" :value="sym" :key="sym">[[ sym ]]</option>
                                </select>
                            </label>
                            <div class="form-row col-span-4">
                                <span>æ–¹å‘</span>
                                <div class="flex gap-2">
                                    <button class="pill-btn" :class="{primary: manualOpen.side==='long'}" @click.prevent="manualOpen.side='long'">åšå¤š</button>
                                    <button class="pill-btn danger" :class="{primary: manualOpen.side==='short'}" @click.prevent="manualOpen.side='short'">åšç©º</button>
                                </div>
                            </div>
                            <label class="form-row col-span-4">
                                <span>æ æ†</span>
                                <input class="input" type="number" min="1" step="1" v-model.number="manualOpen.leverage">
                            </label>

                            <label class="form-row col-span-4">
                                <span>ä»“ä½ï¼ˆUSDï¼‰</span>
                                <input class="input" type="number" min="1" step="10" v-model.number="manualOpen.position_size_usd">
                            </label>
                            <label class="form-row col-span-4">
                                <span>æ­¢æŸ</span>
                                <input class="input" type="number" step="0.0001" v-model.number="manualOpen.stop_loss">
                            </label>
                            <label class="form-row col-span-4">
                                <span>æ­¢ç›ˆ</span>
                                <input class="input" type="number" step="0.0001" v-model.number="manualOpen.take_profit">
                            </label>

                            <label class="form-row col-span-4">
                                <span>Tier1 ç›®æ ‡</span>
                                <input class="input" type="number" step="0.0001" v-model.number="manualOpen.tier1_target">
                            </label>
                            <label class="form-row col-span-4">
                                <span>Tier1 æ¯”ä¾‹ (0-1)</span>
                                <input class="input" type="number" min="0" max="1" step="0.01" v-model.number="manualOpen.tier1_ratio">
                            </label>

                            <label class="form-row col-span-4">
                                <span>Tier2 ç›®æ ‡</span>
                                <input class="input" type="number" step="0.0001" v-model.number="manualOpen.tier2_target">
                            </label>
                            <label class="form-row col-span-4">
                                <span>Tier2 æ¯”ä¾‹ (0-1)</span>
                                <input class="input" type="number" min="0" max="1" step="0.01" v-model.number="manualOpen.tier2_ratio">
                            </label>

                            <label class="form-row col-span-4">
                                <span>Tier3 ç›®æ ‡</span>
                                <input class="input" type="number" step="0.0001" v-model.number="manualOpen.tier3_target">
                            </label>
                            <label class="form-row col-span-4">
                                <span>Tier3 æ¯”ä¾‹ (0-1)</span>
                                <input class="input" type="number" min="0" max="1" step="0.01" v-model.number="manualOpen.tier3_ratio">
                            </label>

                            <label class="form-row col-span-12">
                                <span>å¤‡æ³¨ / ç†ç”±ï¼ˆå†™å…¥å†³ç­–æ—¥å¿—ï¼‰</span>
                                <input class="input" type="text" v-model="manualOpen.reason" placeholder="ä¾‹å¦‚ï¼šåŒåº•å½¢æ€ + FOMC ç©ºçª—å£ï¼Œäººå·¥ä¿¡å·">
                            </label>
                        </div>
                        <div class="muted text-sm mt-4">
                            Tier æ¯”ä¾‹åˆè®¡ï¼š[[ formatPercent(manualTierSum) ]] ï¼ˆéœ€ç­‰äº 100%ï¼‰ã€‚å¦‚æœéœ€è¦ 33/33/34ï¼Œå¯ç›´æ¥å¡« 0.33/0.33/0.34ã€‚
                        </div>
                        <div class="mt-4 flex justify-between items-center">
                            <p class="muted text-xs">æäº¤åç«‹å³æ‰§è¡Œï¼Œå»ºè®®åœ¨åˆ·æ–°å½“å‰ä»·å 30 ç§’å†…å®Œæˆã€‚</p>
                            <button class="pill-btn primary" @click="submitManualOpen" :disabled="manualOpen.submitting">ç«‹å³å¼€ä»“</button>
                        </div>
                    </div>
                </section>

                <section v-if="view==='positionDetail'" class="stack">
                            <div class="notion-block">
                                <div class="block-header">
                                    <div>
                                        <p class="notion-section-title">ä»“ä½è¯¦æƒ…</p>
                                        <h2>Trade #[[ positionDetail.tradeId ]]</h2>
                                        <div class="muted" v-if="positionDetail.data && positionDetail.data.status==='closed'">å·²å¹³ä»“</div>
                                    </div>
                                    <div class="actions">
                                        <button class="pill-btn" @click="switchView('positions')">è¿”å›åˆ—è¡¨</button>
                                        <button class="pill-btn danger" @click="forceClosePosition" :disabled="positionDetail.loading || (positionDetail.data && positionDetail.data.status==='closed')">æ‰‹åŠ¨å…¨å¹³</button>
                                    </div>
                                </div>
                                <div v-if="positionDetail.loading" class="block-skeleton">åŠ è½½ä»“ä½è¯¦æƒ…...</div>
                                <div v-else>
                                    <div v-if="positionDetail.error" class="callout error">[[ positionDetail.error ]]</div>
                                    <div v-if="positionDetail.data" class="detail-grid">
                                <div class="detail-card">
                                    <p class="muted">æ ‡çš„ / æ–¹å‘</p>
                                    <h3>[[ positionDetail.data.symbol ]] Â· [[ (positionDetail.data.side || '').toUpperCase() ]] x[[ positionDetail.data.leverage ]]</h3>
                                    <p class="muted">Entry [[ formatNumber(positionDetail.data.entry_price) ]] Â· Current [[ formatNumber(positionDetail.data.current_price) ]]</p>
                                </div>
                                <div class="detail-card">
                                    <p class="muted">ç›ˆäº</p>
                                    <h3 :class="positionDetail.data.pnl_ratio>0 ? 'text-emerald-600' : (positionDetail.data.pnl_ratio<0 ? 'text-red-600' : '')">[[ formatUSD(positionDetail.data.pnl_usd) ]]</h3>
                                    <p class="muted">ROE [[ formatPercent(positionDetail.data.pnl_ratio) ]]</p>
                                    <p class="muted">å·²å®ç° [[ formatUSD(positionDetail.data.realized_pnl_usd) ]] Â· æœªå®ç° [[ formatUSD(positionDetail.data.unrealized_pnl_usd) ]]</p>
                                    <p class="muted" v-if="positionDetail.data.status==='closed'">å·²å¹³ä»“</p>
                                </div>
                                <div class="detail-card">
                                    <p class="muted">æ­¢ç›ˆ / æ­¢æŸ</p>
                                    <h3>TP [[ formatNumber(positionDetail.data.take_profit) ]] Â· SL [[ formatNumber(positionDetail.data.stop_loss) ]]</h3>
                                    <p class="muted">Remaining [[ positionDetail.data.status==='closed' ? '0%' : formatPercent(positionDetail.data.remaining_ratio || 1) ]]</p>
                                </div>
                                <div class="detail-card">
                                    <p class="muted">ä»·å€¼ / ä¿è¯é‡‘</p>
                                    <h3>æŒä»“ [[ formatNumber(positionDetail.data.position_value) ]] / ä¿è¯é‡‘ [[ formatNumber(positionDetail.data.stake) ]]</h3>
                                    <p class="muted">å·²æŒæœ‰ [[ formatDuration(positionDetail.data.holding_ms) ]]</p>
                                </div>
                            </div>

                            <div class="tier-board" v-if="positionDetail.data">
                                <div class="tier-row" v-for="tier in tierRows(positionDetail.data)" :key="tier.name">
                                    <div class="tier-name">[[ tier.name ]]</div>
                                    <div class="tier-target">[[ tier.target ]]</div>
                                    <div class="tier-ratio">[[ tier.ratio ]]</div>
                                    <div class="tier-status" :class="tier.done || positionDetail.data.status==='closed' ? 'done' : ''">[[ (tier.done || positionDetail.data.status==='closed') ? 'âœ…' : 'å¾…è§¦å‘' ]]</div>
                                </div>
                            </div>

                                <div class="notion-block mt-6">
                                    <div class="block-header">
                                        <h3>ä¿®æ”¹æ—¥å¿—</h3>
                                        <div class="muted">æœ€è¿‘å˜æ›´</div>
                                    </div>
                                    <div v-if="!positionDetail.data.tier_logs || !positionDetail.data.tier_logs.length" class="muted italic">æš‚æ— æ—¥å¿—</div>
                                    <div class="log-list" v-else>
                                        <div class="log-row" v-for="log in positionDetail.data.tier_logs" :key="log.timestamp">
                                            <div>[[ formatDateTime(log.timestamp) ]]</div>
                                        <div class="muted">[[ tierFieldLabelCN(log.field) ]]</div>
                                            <div>[[ log.old_value ]] â†’ [[ log.new_value ]]</div>
                                            <div class="muted">[[ log.reason ]]</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="notion-block mt-6">
                                    <div class="block-header">
                                        <h3>äº‹ä»¶æµæ°´</h3>
                                        <div class="muted">æ¥è‡ª trade_operation_log</div>
                                    </div>
                                    <div v-if="!positionDetail.data.events || !positionDetail.data.events.length" class="muted italic">æš‚æ— äº‹ä»¶</div>
                                <div class="log-list" v-else>
                                    <div class="log-row" v-for="ev in positionDetail.data.events" :key="ev.timestamp">
                                        <div>[[ formatDateTime(ev.timestamp) ]]</div>
                                    <div class="muted">[[ operationLabel(ev.operation) ]]</div>
                                        <div class="muted">[[ ev.details && ev.details.reason ]]</div>
                                    </div>
                                </div>
                            </div>

                            <div class="notion-block mt-6" v-if="positionDetail.data">
                                <div class="block-header">
                                    <h3>æ‰‹åŠ¨è°ƒæ•´ TP/SL ä¸åˆ†æ®µ</h3>
                                    <div class="muted">æäº¤åå°†é€šè¿‡ /api/live/freqtrade/tiers æ›´æ–°</div>
                                </div>
                                <div class="grid gap-4 form-grid" style="grid-template-columns: repeat(12, minmax(0, 1fr));">
                                    <label class="form-row col-span-6">
                                        <span>æ­¢ç›ˆä»·æ ¼</span>
                                        <input class="input" type="number" v-model.number="tierForm.take_profit" step="0.0001">
                                    </label>
                                    <label class="form-row col-span-6">
                                        <span>æ­¢æŸä»·æ ¼</span>
                                        <input class="input" type="number" v-model.number="tierForm.stop_loss" step="0.0001">
                                    </label>

                                    <label class="form-row col-span-6">
                                        <span>ä¸€é˜¶ä»·æ ¼</span>
                                        <input class="input" type="number" v-model.number="tierForm.tier1_target" step="0.0001">
                                    </label>
                                    <label class="form-row col-span-6">
                                        <span>ä¸€é˜¶æ¯”ä¾‹</span>
                                        <input class="input" type="number" v-model.number="tierForm.tier1_ratio" step="0.01" min="0" max="1">
                                    </label>

                                    <label class="form-row col-span-6">
                                        <span>äºŒé˜¶ä»·æ ¼</span>
                                        <input class="input" type="number" v-model.number="tierForm.tier2_target" step="0.0001">
                                    </label>
                                    <label class="form-row col-span-6">
                                        <span>äºŒé˜¶æ¯”ä¾‹</span>
                                        <input class="input" type="number" v-model.number="tierForm.tier2_ratio" step="0.01" min="0" max="1">
                                    </label>

                                    <label class="form-row col-span-6">
                                        <span>ä¸‰é˜¶ä»·æ ¼</span>
                                        <input class="input" type="number" v-model.number="tierForm.tier3_target" step="0.0001">
                                    </label>
                                    <label class="form-row col-span-6">
                                        <span>ä¸‰é˜¶æ¯”ä¾‹</span>
                                        <input class="input" type="number" v-model.number="tierForm.tier3_ratio" step="0.01" min="0" max="1">
                                    </label>

                                    <label class="form-row col-span-12">
                                        <span>å¤‡æ³¨</span>
                                        <input class="input" type="text" v-model="tierForm.reason" placeholder="å˜æ›´åŸå› ">
                                    </label>
                                </div>
                                <div class="mt-4 flex justify-end">
                                    <button class="pill-btn primary" @click="updateTierSettings" :disabled="positionDetail.loading">æäº¤ä¿®æ”¹</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section v-if="view==='logs'" class="stack">
                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">å®æ—¶æ—¥å¿—</p>
                                <h2>Logs</h2>
                                <p class="muted">æ‹‰å–åç«¯ log_path/llm_log_path æœ€è¿‘è‹¥å¹²è¡Œ</p>
                            </div>
                            <div class="actions">
                                <select class="input" v-model="logs.name" @change="loadLogs(true)">
                                    <option v-for="name in logs.available" :key="name" :value="name">[[ name ]]</option>
                                </select>
                                <button class="pill-btn" @click="loadLogs(true)" :disabled="logs.loading">åˆ·æ–°</button>
                            </div>
                        </div>
                        <div v-if="logs.loading" class="block-skeleton">åŠ è½½æ—¥å¿—...</div>
                        <div v-else>
                            <div v-if="logs.error" class="callout error">[[ logs.error ]]</div>
                            <div class="log-view" v-if="logs.lines.length">
                                <div class="log-line" v-for="(line, idx) in logs.lines" :key="idx">[[ line ]]</div>
                            </div>
                            <p v-else class="muted italic">æš‚æ— æ—¥å¿—å†…å®¹</p>
                        </div>
                    </div>
                </section>
            </main>
        </div>
        <div v-if="toast.message" class="toast" :class="toast.type">[[ toast.message ]]</div>
        <div v-if="imagePreview.visible" class="image-modal" @click.self="closeImagePreview">
            <div class="image-modal-content">
                <img :src="imagePreview.src" :alt="imagePreview.desc || 'LLM Attachment'">
                <p class="image-modal-desc" v-if="imagePreview.desc">[[ imagePreview.desc ]]</p>
                <div class="image-modal-actions">
                    <a class="pill-btn" :href="imagePreview.src" target="_blank" rel="noopener">åœ¨æ–°æ ‡ç­¾æ‰“å¼€</a>
                    <button class="pill-btn" @click="closeImagePreview">å…³é—­</button>
                </div>
            </div>
        </div>
    </script>

    <div id="app"></div>

    <script>
        window.__APP_INIT__ = {
            view: "{{ if .InitialView }}{{ .InitialView }}{{ else }}desk{{ end }}",
            decisionId: {{ if .DecisionID }}{{ .DecisionID }}{{ else }}null{{ end }},
            traceId: {{ if .TraceID }}{{ printf "%q" .TraceID }}{{ else }}null{{ end }},
            tradeId: {{ if .TradeID }}{{ .TradeID }}{{ else }}null{{ end }},
            symbol: {{ if .Symbol }}{{ printf "%q" .Symbol }}{{ else }}""{{ end }},
            selectedSymbols: {{ if .SelectedSymbols }}{{ toJSON .SelectedSymbols }}{{ else }}[]{{ end }},
            defaultSymbols: {{ toJSON .DefaultSymbols }},
        };
    </script>
    <script src="/static/js/admin-app.js"></script>
</body>
</html>
