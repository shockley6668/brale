<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Break A Leg ¬∑ Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap">
    <link rel="stylesheet" href="/static/css/notion.css">
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
</head>

<body>
    <script type="text/x-template" id="app-template">
        <div class="app-frame" :class="{'is-mobile': isMobile}">
            <header class="top-nav">
                <div class="nav-main">
                    <div class="nav-logo">
                        <div class="emoji">üìò</div>
                        <div>
                            <p class="nav-label">Break A Leg</p>
                            <h2>Live Console</h2>
                        </div>
                    </div>
                    <div class="nav-meta">Êó†Èâ¥ÊùÉ ¬∑ ÂÆûÁõò API</div>
                    <button class="pill-btn nav-toggle" v-if="isMobile" @click="navCollapsed = !navCollapsed">
                        [[ navCollapsed ? 'Â±ïÂºÄËèúÂçï' : 'Êî∂Ëµ∑ËèúÂçï' ]]
                    </button>
                                </div>
                <div class="top-nav-links" :class="{'open': !navCollapsed || !isMobile}">
                    <button class="nav-item" :class="{active: view==='desk'}" @click="switchView('desk')">Desk ¬∑ ÊÄªËßà</button>
                    <button class="nav-item" :class="{active: view==='decisions'}" @click="switchView('decisions')">Blue Book ¬∑ ÂÜ≥Á≠ñ</button>
                    <button class="nav-item" :class="{active: view==='positions'}" @click="switchView('positions')">Red Book ¬∑ ‰ªì‰Ωç</button>
                    <button class="nav-item" :class="{active: view==='manualOpen'}" @click="switchView('manualOpen')">Manual ¬∑ ÊâãÂä®ÂºÄ‰ªì</button>
                    <button class="nav-item" :class="{active: view==='logs'}" @click="switchView('logs')">Logs ¬∑ ÂÆûÊó∂</button>
                    <div class="nav-footer muted">Êï∞ÊçÆÂØÜÈõÜÔºåË∞®ÊÖéÊìç‰Ωú üõ∞</div>
                                </div>
            </header>
            <div v-if="isMobile && !navCollapsed" class="nav-backdrop" @click="navCollapsed = true"></div>

            <main class="main-panel">
                <header class="page-header">
                    <div>
                        <p class="eyebrow">[[ headline.eyebrow ]]</p>
                        <h1>[[ headline.title ]]</h1>
                        <p class="muted" v-if="headline.desc">[[ headline.desc ]]</p>
                    </div>
                    <div class="actions">
                        <button class="pill-btn" @click="refreshCurrent" :disabled="loadingAny">Âà∑Êñ∞</button>
                        <button class="pill-btn primary" @click="switchView('positions')">Âø´ÈÄüÊü•Áúã‰ªì‰Ωç</button>
                    </div>
                </header>

                <section v-if="view==='desk'" class="stack">
                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">Enabled Symbols</p>
                                <h2>ÂΩìÂâçÂêØÁî®ÁöÑÂ∏ÅÁßç</h2>
                                <p class="muted">Êù•Ëá™ profiles.yaml ÁöÑËøêË°åÈÖçÁΩÆ</p>
                            </div>
                            <div class="muted">ÂÖ± [[ enabledSymbols.length ]] ‰∏™</div>
                        </div>
                        <div class="filter-tags">
                            <span class="tag active" v-for="sym in enabledSymbols" :key="sym">[[ sym ]]</span>
                            <p v-if="!enabledSymbols.length" class="muted italic">ÊöÇÊó†ÈÖçÁΩÆÁöÑÂ∏ÅÁßç</p>
                        </div>
                    </div>

                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">Decision Stream</p>
                                <h2>ÊúÄÊñ∞ÂÜ≥Á≠ñÔºàÂ∑≤ÂêØÁî®Â∏ÅÁßçÔºâ</h2>
                            </div>
                            <div class="muted">ÂÆûÊó∂ÊãâÂèñ /api/live/decisions ¬∑ stage=final</div>
                        </div>
                        <div v-if="desk.loading" class="block-skeleton">Âä†ËΩΩÂÜ≥Á≠ñÊµÅ...</div>
                        <div v-else>
                            <div v-if="desk.error" class="callout error">[[ desk.error ]]</div>
                            <div class="capsule-list" v-if="filteredDeskDecisions.length">
                                <div class="capsule-card" v-for="item in filteredDeskDecisions" :key="item.log.id" @click="openDecision(item.log.id)">
                                    <div class="capsule-head">
                                        <div>
                                            <div class="capsule-time">[[ formatTime(item.log.ts) ]]</div>
                                            <div class="capsule-date">[[ formatDate(item.log.ts) ]]</div>
                                        </div>
                                        <span class="badge" :class="badgeClass(item.action)">[[ item.actionLabel ]]</span>
                                    </div>
                                    <div class="capsule-symbols">[[ item.log.symbols && item.log.symbols.length ? item.log.symbols.join(' / ') : 'Â§öÊ†áÁöÑ' ]]</div>
                                    <div class="card-meta">H [[ item.log.horizon || 'N/A' ]] ¬∑ [[ item.stepCount ]] steps</div>
                                    <p class="card-text">[[ item.summary ]]</p>
                                    <div class="capsule-footer">
                                        <div class="capsule-agents">
                                            <div class="agent-dots">
                                                <span class="agent-dot" v-for="dot in Math.min(item.providerCount,4)" :key="dot"></span>
                                                <span v-if="item.providerCount>4" class="agent-dot" :title="'+'+(item.providerCount-4)"></span>
                                            </div>
                                            <div class="capsule-agent-count">[[ item.providerCount ]] Agents</div>
                                        </div>
                                        <div :class="['capsule-status', item.hasError ? 'danger' : 'success']">
                                            [[ item.hasError ? '‚ö†Ô∏é È£éÊéßÂÖ≥Ê≥®' : 'Á®≥ÊÄÅÈÄöËøá' ]]
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p v-else class="muted italic">ÊöÇÊó†ÂÜ≥Á≠ñËÆ∞ÂΩï„ÄÇ</p>
                        </div>
                    </div>

                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">Strategy Runtime</p>
                                <h2>ËøêË°å‰∏≠ÁöÑÁ≠ñÁï•</h2>
                                <p class="muted">ÁÇπÂáªË∑≥ËΩ¨Êü•ÁúãÁ≠ñÁï•Áõ∏ÂÖ≥ÂÜ≥Á≠ñ</p>
                            </div>
                        </div>
                        <div v-if="desk.loading" class="block-skeleton">Âä†ËΩΩÁ≠ñÁï•...</div>
                        <div v-else>
                            <div class="provider-grid" v-if="strategyCards.length">
                                <div class="provider-card runtime-card" v-for="card in strategyCards" :key="card.symbol" @click="openStrategyConfig(card.symbol)">
                                    <div class="provider-card-header">
                                        <div>
                                            <p class="provider-name">[[ card.symbol ]]</p>
                                            <p class="provider-time muted">Profile [[ card.profileLabel || 'N/A' ]]</p>
                                        </div>
                                        <span class="badge badge-neutral">ÈÖçÁΩÆ</span>
                                    </div>
                                    <div class="runtime-prompts compact">
                                        <div class="runtime-chip">
                                            <p class="runtime-chip-label">System</p>
                                            <p class="runtime-chip-value">[[ card.systemPromptLabel ]]</p>
                                        </div>
                                        <div class="runtime-chip">
                                            <p class="runtime-chip-label">User</p>
                                            <p class="runtime-chip-value">[[ card.userPromptLabel ]]</p>
                                        </div>
                                    </div>
                                    <div class="runtime-section">
                                        <div class="runtime-section-title">‰∏≠Èó¥‰ª∂</div>
                                        <div v-if="card.middlewareItems.length" class="runtime-list grid compact">
                                            <div class="runtime-item compact" v-for="mw in card.middlewareItems" :key="mw.key">
                                                <div class="runtime-item-head">
                                                    <span class="runtime-pill">[[ mw.name ]]</span>
                                                    <span class="runtime-meta" v-if="mw.paramsLabel">[[ mw.paramsLabel ]]</span>
                                                </div>
                                            </div>
                                        </div>
                                        <p v-else class="muted italic">Êú™ÈÖçÁΩÆ‰∏≠Èó¥‰ª∂</p>
                                    </div>
                                    <div class="runtime-section">
                                        <div class="runtime-section-title">Âá∫Âú∫Á≠ñÁï•</div>
                                        <div class="runtime-exit">
                                            <p class="runtime-exit-summary">[[ card.exitSummary || (card.strategyItems[0] && (card.strategyItems[0].desc || card.strategyItems[0].id)) || 'Êú™ÈÖçÁΩÆ' ]]</p>
                                            <div class="runtime-combos" v-if="card.exitCombos && card.exitCombos.length">
                                                <span class="runtime-pill primary" v-for="combo in card.exitCombos" :key="combo">[[ combo ]]</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p v-else class="muted italic">ÊöÇÊó†ËøêË°å‰∏≠ÁöÑÁ≠ñÁï•„ÄÇ</p>
                        </div>
                    </div>

                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">Position Monitor</p>
                                <h2>ÊúÄÊñ∞ÊåÅ‰ªì</h2>
                            </div>
                            <div class="muted">Êï∞ÊçÆÊù•Ëá™ /api/live/freqtrade/positions</div>
                        </div>
                        <div v-if="desk.loading" class="block-skeleton">Âä†ËΩΩ‰ªì‰Ωç...</div>
                        <div v-else>
                            <div v-if="desk.error" class="callout error">[[ desk.error ]]</div>
                            <div class="pos-grid" v-if="desk.positions.length">
                                <div class="pos-card" v-for="p in desk.positions" :key="p.trade_id" @click="openPosition(p.trade_id)">
                                    <div>
                                        <div class="pos-main-header">
                                            <div class="pos-symbol">[[ p.symbol ]]</div>
                                            <span class="pos-status" :class="statusBadgeClass(p.status)">[[ statusLabel(p.status) ]]</span>
                                        </div>
                                        <div class="pos-meta">[[ (p.side || '').toUpperCase() ]] ¬∑ x[[ p.leverage ]]</div>
                                        <div class="pos-sub mt-2">Entry [[ formatNumber(p.entry_price) ]]</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="pos-pnl" :class="p.pnl_ratio>0 ? 'positive' : (p.pnl_ratio<0 ? 'negative' : '')">[[ formatUSD(p.pnl_usd) ]]</div>
                                        <div class="pos-sub">ROE [[ formatPercent(p.pnl_ratio) ]]</div>
                                        <!-- realized pnl removed -->
                                        <div class="pos-sub">Êú™ÂÆûÁé∞ [[ formatUSD(p.unrealized_pnl_usd) ]]</div>
                                        <div class="pos-sub mt-2">SL [[ formatNumber(p.stop_loss) ]] / TP [[ formatNumber(p.take_profit) ]]</div>
                                    </div>
                                </div>
                            </div>
                            <p v-else class="muted italic">ÊöÇÊó†ÊåÅ‰ªì„ÄÇ</p>
                        </div>
                    </div>
                </section>

                <section v-if="view==='decisions'" class="stack">
                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">Á≠õÈÄâ</p>
                                <h2>Â∏ÅÁßçÂø´ÈÄüÁ≠õÈÄâ</h2>
                                <p class="muted">ÁÇπÂáªÊ†áÁ≠æÂ§öÈÄâ ¬∑ ÈªòËÆ§ÂàóÂá∫ÂÖ®ÈÉ®</p>
                            </div>
                            <div class="muted">ÂÖ± [[ decisions.total ]] Êù°</div>
                        </div>
                    <div class="filter-tags">
                        <button class="tag" :class="{active: !decisions.symbols.length}" @click="clearSymbols">All</button>
                        <button class="tag" v-for="sym in defaultSymbols" :key="sym" :class="{active: decisions.symbols.includes(sym)}" @click="toggleSymbol(sym)">[[ sym ]]</button>
                    </div>
                </div>

                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">Ê®°ÂûãËæìÂá∫</p>
                                <h2>ÊúÄÊñ∞ Provider ÂìçÂ∫î</h2>
                                <p class="muted">ÊØè‰∏™Â∏ÅÁßç‰ªÖÂ±ïÁ§∫ÊúÄÊñ∞‰∏ÄËΩÆÔºàstage=providerÔºâ</p>
                            </div>
                        </div>
                        <div v-if="decisions.providersLoading" class="block-skeleton">Âä†ËΩΩ Provider ËæìÂá∫...</div>
                        <div v-else>
                            <div v-if="decisions.providersError" class="callout error">[[ decisions.providersError ]]</div>
                            <div class="provider-grid" v-if="decisions.providers.length">
                                <div class="provider-card" v-for="item in decisions.providers" :key="item.id">
                                    <div class="provider-card-header">
                                        <div>
                                            <p class="provider-name">[[ item.provider ]]</p>
                                            <p class="provider-time muted">[[ formatTime(item.ts) ]] ¬∑ [[ formatDate(item.ts) ]]</p>
                                        </div>
                                        <span class="badge" :class="badgeClass(item.action)">[[ item.actionLabel ]]</span>
                                    </div>
                                    <div class="provider-symbols">[[ item.symbolLabel ]]</div>
                                    <p class="provider-summary">[[ item.summary ]]</p>
                                </div>
                            </div>
                            <p v-else class="muted italic">ÊöÇÊó† Provider ËæìÂá∫„ÄÇ</p>
                        </div>
                    </div>

                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">ÂÜ≥Á≠ñÊµÅ</p>
                                <h2>ËÉ∂ÂõäÂºèÂÜ≥Á≠ñÊµÅ</h2>
                                <p class="muted">ÊØè‰∏™Â∏ÅÁßçÊØèÈ°µÂ±ïÁ§∫ÊúÄËøë 2 ËΩÆ ¬∑ ÁÇπÂáªÂ±ïÂºÄÊï¥ËΩÆÊÄùÁª¥Èìæ</p>
                            </div>
                            <div class="muted">Page [[ decisions.flowPage ]]</div>
                        </div>
                        <div v-if="decisions.loading" class="block-skeleton">Âä†ËΩΩÂÜ≥Á≠ñÊµÅ...</div>
                        <div v-else>
                            <div v-if="decisions.error" class="callout error">[[ decisions.error ]]</div>
                            <div class="capsule-list" v-if="decisions.items.length">
                                <div class="capsule-card" v-for="item in decisions.items" :key="item.log.id" @click="openDecision(item.log.id)">
                                    <div class="capsule-head">
                                        <div>
                                            <div class="capsule-time">[[ formatTime(item.log.ts) ]]</div>
                                            <div class="capsule-date">[[ formatDate(item.log.ts) ]]</div>
                                        </div>
                                        <span class="badge" :class="badgeClass(item.action)">[[ item.actionLabel ]]</span>
                                    </div>
                                    <div class="capsule-symbols">[[ item.log.symbols && item.log.symbols.length ? item.log.symbols.join(' / ') : 'Â§öÊ†áÁöÑ' ]]</div>
                                    <div class="card-meta">H [[ item.log.horizon || 'N/A' ]] ¬∑ [[ item.stepCount ]] steps</div>
                                    <p class="card-text">[[ item.summary ]]</p>
                                    <div class="capsule-footer">
                                        <div class="capsule-agents">
                                            <div class="agent-dots">
                                                <span class="agent-dot" v-for="dot in Math.min(item.providerCount,4)" :key="dot"></span>
                                                <span v-if="item.providerCount>4" class="agent-dot" :title="'+'+(item.providerCount-4)"></span>
                                            </div>
                                            <div class="capsule-agent-count">[[ item.providerCount ]] Agents</div>
                                        </div>
                                        <div :class="['capsule-status', item.hasError ? 'danger' : 'success']">
                                            [[ item.hasError ? '‚ö†Ô∏é Issues' : 'Clean pass' ]]
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p v-else class="muted italic">ÊöÇÊó†ÂÜ≥Á≠ñËÆ∞ÂΩï„ÄÇ</p>
                        </div>
                        <div class="pager" v-if="decisionFlowCanPage">
                            <button class="pill-btn" :disabled="!decisionFlowHasPrev" @click="changeDecisionPage(-1)">‰∏ä‰∏ÄÈ°µ</button>
                            <span class="muted">Á¨¨ [[ decisions.flowPage ]] È°µ</span>
                            <button class="pill-btn" :disabled="!decisionFlowHasNext" @click="changeDecisionPage(1)">‰∏ã‰∏ÄÈ°µ</button>
                        </div>
                    </div>
                </section>

                <section v-if="view==='decisionDetail'" class="stack">
                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">ÂÜ≥Á≠ñËØ¶ÊÉÖ</p>
                                <h2>Trace #[[ decisionDetail.id ]]</h2>
                            </div>
                            <div class="actions">
                                <button class="pill-btn" @click="switchView('decisions')">ËøîÂõûÂàóË°®</button>
                            </div>
                        </div>
                        <div v-if="decisionDetail.loading" class="block-skeleton">Âä†ËΩΩÂÜ≥Á≠ñËØ¶ÊÉÖ...</div>
                        <div v-else>
                            <div v-if="decisionDetail.error" class="callout error">[[ decisionDetail.error ]]</div>
                            <div v-if="decisionDetail.data">
                                <div class="detail-head">
                                    <div>
                                        <p class="muted">[[ decisionDetail.data.log.symbols && decisionDetail.data.log.symbols.length ? decisionDetail.data.log.symbols.join(' / ') : 'Â§öÊ†áÁöÑ' ]]</p>
                                        <h3>[[ decisionHeadline(decisionDetail.data.log, decisionDetail.data.trace) ]]</h3>
                                        <p class="muted">H [[ decisionDetail.data.log.horizon || 'N/A' ]] ¬∑ [[ formatDateTime(decisionDetail.data.log.ts) ]]</p>
                                    </div>
                                    <div class="badge" :class="badgeClass(decisionHeadlineAction(decisionDetail.data.log, decisionDetail.data.trace))">[[ decisionHeadline(decisionDetail.data.log, decisionDetail.data.trace) ]]</div>
                                </div>
                                <div class="notion-block mt-4">
                                    <div class="block-header">
                                        <div>
                                            <p class="notion-section-title">Á≠õÈÄâ</p>
                                            <h3>ÊåâÈò∂ÊÆµ / Provider ËøáÊª§</h3>
                                        </div>
                                        <div class="flex gap-2 items-center">
                                            <select class="input" v-model="decisionFilters.provider">
                                                <option value="">ÂÖ®ÈÉ® Provider</option>
                                                <option v-for="p in decisionProviders" :key="p" :value="p">[[ p ]]</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="filter-tags">
                                        <button class="tag" :class="{active: decisionFilters.stage==='all'}" @click="setStageFilter('all')">ÂÖ®ÈÉ®</button>
                                        <button class="tag" :class="{active: decisionFilters.stage==='provider'}" @click="setStageFilter('provider')">Provider</button>
                                        <button class="tag" :class="{active: decisionFilters.stage==='agent'}" @click="setStageFilter('agent')">Agent</button>
                                        <button class="tag" :class="{active: decisionFilters.stage==='final'}" @click="setStageFilter('final')">Final</button>
                                        <button class="tag" :class="{active: decisionFilters.stage==='other'}" @click="setStageFilter('other')">Other</button>
                                    </div>
                                </div>
                                <div class="step-list" v-if="decisionDetail.data.trace && decisionDetail.data.trace.steps">
                                    <div class="step-card" v-for="(step, idx) in filteredDecisionSteps" :key="idx">
                                        <div class="step-head">
                                            <div class="step-head-left">
                                                <span class="stage-pill" :class="stageBadgeClass(step.stage)">[[ stageLabel(step.stage) ]]</span>
                                                <span class="stage-detail" v-if="stageDetail(step.stage)">[[ stageDetail(step.stage) ]]</span>
                                                <span class="step-provider">[[ step.provider_id || 'N/A' ]]</span>
                                            </div>
                                            <div class="step-head-right">[[ formatDateTime(step.ts) ]]</div>
                                        </div>
                                        <div class="step-label">LLM Output</div>
                                        <pre class="step-text">[[ step.meta_summary || step.raw_output || '‚Äî' ]]</pre>
                                        <template v-if="step.images && step.images.length">
                                            <div class="step-label">Image Attachments ([[ step.images.length ]])</div>
                                            <div class="step-images">
                                                <div class="step-image-card" v-for="(img, imgIdx) in step.images" :key="img.data_uri || imgIdx">
                                                    <img class="step-image-thumb" :src="img.data_uri" :alt="img.description || ('Attachment #' + (imgIdx+1))" @click="openImagePreview(img)">
                                                    <p class="step-image-desc" v-if="(img.description || '').trim()">[[ img.description ]]</p>
                                                    <a class="step-image-link" :href="img.data_uri" target="_blank" rel="noopener">Êü•ÁúãÂéüÂõæ</a>
                                                </div>
                                            </div>
                                        </template>
                                        <div class="step-label" v-if="step.decisions && step.decisions.length">Parsed Decisions</div>
                                        <ul v-if="step.decisions && step.decisions.length" class="decision-list">
                                            <li v-for="d in step.decisions" :key="d.action">
                                                <span class="badge" :class="badgeClass(d.action)">[[ d.action.toUpperCase() ]]</span>
                                                <span class="muted ml-2">TP [[ formatNumber(d.take_profit) ]] ¬∑ SL [[ formatNumber(d.stop_loss) ]]</span>
                                            </li>
                                        </ul>
                                        <div class="step-error" v-if="step.error">‚ö†Ô∏é [[ step.error ]]</div>

                                        <template v-if="stageLabel(step.stage)==='AGENT'">
                                            <div class="step-label mt-4">Prompts</div>
                                            <pre class="step-text">[[ mergedAgentPrompt(step) ]]</pre>
                                            <template v-for="(block, blockIdx) in extractCsvBlocks(step.user_prompt)" :key="csvBlockKey(step, blockIdx, block.tag)">
                                                <div class="csv-block">
                                                    <button class="csv-toggle" type="button" @click="toggleCsvBlock(csvBlockKey(step, blockIdx, block.tag))">
                                                        <span>[[ block.label ]] ¬∑ [[ block.rows.length ]]Ë°å</span>
                                                        <span>[[ isCsvExpanded(csvBlockKey(step, blockIdx, block.tag)) ? 'Êî∂Ëµ∑' : 'Â±ïÂºÄ' ]]</span>
                                                    </button>
                                                    <div class="csv-table-wrapper" v-if="isCsvExpanded(csvBlockKey(step, blockIdx, block.tag))">
                                                        <table class="csv-table">
                                                            <thead>
                                                                <tr>
                                                                    <th v-for="(header, headerIdx) in block.headers" :key="headerIdx">[[ header ]]</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr v-for="(row, rowIdx) in block.rows" :key="rowIdx">
                                                                    <td v-for="(cell, cellIdx) in row" :key="cellIdx">[[ cell ]]</td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </template>
                                        </template>
                                        <template v-if="stageLabel(step.stage)==='PROVIDER' && (decisionFilters.stage || '').toLowerCase() === 'provider'">
                                            <div class="step-label mt-4">Prompts</div>
                                            <div v-if="!((step.system_prompt || '').trim() || (step.user_prompt || '').trim())" class="muted italic">
                                                ÊöÇÊó† Prompt Êï∞ÊçÆ„ÄÇ
                                            </div>
                                            <template v-else>
                                                <div class="step-label" v-if="showSystemPrompt && (step.system_prompt || '').trim()">System Prompt</div>
                                                <pre class="step-text" v-if="showSystemPrompt && (step.system_prompt || '').trim()">[[ step.system_prompt ]]</pre>
                                                <template v-if="showUserPrompt">
                                                    <div class="step-label">User Prompt</div>
                                                    <pre class="step-text">[[ cleanUserPrompt(step.user_prompt) ]]</pre>
                                                    <template v-for="(block, blockIdx) in extractCsvBlocks(step.user_prompt)" :key="csvBlockKey(step, blockIdx, block.tag)">
                                                        <div class="csv-block">
                                                            <button class="csv-toggle" type="button" @click="toggleCsvBlock(csvBlockKey(step, blockIdx, block.tag))">
                                                                <span>[[ block.label ]] ¬∑ [[ block.rows.length ]]Ë°å</span>
                                                                <span>[[ isCsvExpanded(csvBlockKey(step, blockIdx, block.tag)) ? 'Êî∂Ëµ∑' : 'Â±ïÂºÄ' ]]</span>
                                                            </button>
                                                            <div class="csv-table-wrapper" v-if="isCsvExpanded(csvBlockKey(step, blockIdx, block.tag))">
                                                                <table class="csv-table">
                                                                    <thead>
                                                                        <tr>
                                                                            <th v-for="(header, headerIdx) in block.headers" :key="headerIdx">[[ header ]]</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        <tr v-for="(row, rowIdx) in block.rows" :key="rowIdx">
                                                                            <td v-for="(cell, cellIdx) in row" :key="cellIdx">[[ cell ]]</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </template>
                                            </template>
                                        </template>
                                    </div>
                                </div>
                                <div class="mobile-step-toggle" v-if="stepExpandAvailable">
                                    <button class="pill-btn" @click="expandMobileSteps = !expandMobileSteps">
                                        [[ expandMobileSteps ? 'Êî∂Ëµ∑ÂÖ®ÈÉ®Ê≠•È™§' : 'Â±ïÂºÄÂÖ®ÈÉ®Ê≠•È™§' ]]
                                    </button>
                                </div>
                                <div class="notion-block mt-4" v-if="decisionFilters.stage!=='agent'">
                                    <div class="block-header">
                                        <div>
                                            <p class="notion-section-title">Prompts</p>
                                            <h3>[[ (decisionFilters.stage || '').toLowerCase() === 'provider' ? 'Provider Prompts' : 'Shared Prompt' ]]</h3>
                                        </div>
                                        <div class="prompt-toggle">
                                            <button class="pill-btn" :class="{primary: showSystemPrompt}" @click="showSystemPrompt = !showSystemPrompt">
                                                [[ showSystemPrompt ? 'ÈöêËóè System Prompt' : 'ÊòæÁ§∫ System Prompt' ]]
                                            </button>
                                            <button class="pill-btn" :class="{primary: showUserPrompt}" @click="showUserPrompt = !showUserPrompt">
                                                [[ showUserPrompt ? 'ÈöêËóè User Prompt' : 'ÊòæÁ§∫ User Prompt' ]]
                                            </button>
                                        </div>
                                    </div>
                                    <template v-if="(decisionFilters.stage || '').toLowerCase() === 'provider'">
                                        <div v-if="!providerPromptBlocks.length" class="muted italic">
                                            ÊöÇÊó† Prompt Êï∞ÊçÆ„ÄÇ
                                        </div>
                                        <template v-else>
                                            <div v-for="prompt in providerPromptBlocks" :key="prompt.providerId" class="mt-4">
                                                <div class="step-label">[[ prompt.providerId ]]</div>
                                                <div class="step-label" v-if="showSystemPrompt && (prompt.systemPrompt || '').trim()">System Prompt</div>
                                                <pre class="step-text" v-if="showSystemPrompt && (prompt.systemPrompt || '').trim()">[[ prompt.systemPrompt ]]</pre>
                                                <template v-if="showUserPrompt">
                                                    <div class="step-label">User Prompt</div>
                                                    <pre class="step-text">[[ cleanUserPrompt(prompt.userPrompt) ]]</pre>
                                                    <template v-for="(block, blockIdx) in extractCsvBlocks(prompt.userPrompt)" :key="providerCsvBlockKey(prompt.providerId, blockIdx, block.tag)">
                                                        <div class="csv-block">
                                                            <button class="csv-toggle" type="button" @click="toggleCsvBlock(providerCsvBlockKey(prompt.providerId, blockIdx, block.tag))">
                                                                <span>[[ block.label ]] ¬∑ [[ block.rows.length ]]Ë°å</span>
                                                                <span>[[ isCsvExpanded(providerCsvBlockKey(prompt.providerId, blockIdx, block.tag)) ? 'Êî∂Ëµ∑' : 'Â±ïÂºÄ' ]]</span>
                                                            </button>
                                                            <div class="csv-table-wrapper" v-if="isCsvExpanded(providerCsvBlockKey(prompt.providerId, blockIdx, block.tag))">
                                                                <table class="csv-table">
                                                                    <thead>
                                                                        <tr>
                                                                            <th v-for="(header, headerIdx) in block.headers" :key="headerIdx">[[ header ]]</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        <tr v-for="(row, rowIdx) in block.rows" :key="rowIdx">
                                                                            <td v-for="(cell, cellIdx) in row" :key="cellIdx">[[ cell ]]</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </template>
                                            </div>
                                        </template>
                                    </template>
                                    <template v-else>
                                        <div v-if="!((sharedPrompts.systemPrompt || '').trim() || (sharedPrompts.userPrompt || '').trim())" class="muted italic">
                                            ÊöÇÊó† Prompt Êï∞ÊçÆ„ÄÇ
                                        </div>
                                        <template v-else>
                                            <div class="step-label" v-if="showSystemPrompt && (sharedPrompts.systemPrompt || '').trim()">System Prompt</div>
                                            <pre class="step-text" v-if="showSystemPrompt && (sharedPrompts.systemPrompt || '').trim()">[[ sharedPrompts.systemPrompt ]]</pre>
                                            <template v-if="showUserPrompt">
                                                <div class="step-label">User Prompt</div>
                                                <pre class="step-text">[[ cleanUserPrompt(sharedPrompts.userPrompt) ]]</pre>
                                                <template v-for="(block, blockIdx) in extractCsvBlocks(sharedPrompts.userPrompt)" :key="sharedCsvBlockKey(blockIdx, block.tag)">
                                                    <div class="csv-block">
                                                        <button class="csv-toggle" type="button" @click="toggleCsvBlock(sharedCsvBlockKey(blockIdx, block.tag))">
                                                            <span>[[ block.label ]] ¬∑ [[ block.rows.length ]]Ë°å</span>
                                                            <span>[[ isCsvExpanded(sharedCsvBlockKey(blockIdx, block.tag)) ? 'Êî∂Ëµ∑' : 'Â±ïÂºÄ' ]]</span>
                                                        </button>
                                                        <div class="csv-table-wrapper" v-if="isCsvExpanded(sharedCsvBlockKey(blockIdx, block.tag))">
                                                            <table class="csv-table">
                                                                <thead>
                                                                    <tr>
                                                                        <th v-for="(header, headerIdx) in block.headers" :key="headerIdx">[[ header ]]</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    <tr v-for="(row, rowIdx) in block.rows" :key="rowIdx">
                                                                        <td v-for="(cell, cellIdx) in row" :key="cellIdx">[[ cell ]]</td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </template>
                                            </template>
                                        </template>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section v-if="view==='positions'" class="stack">
                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">Á≠õÈÄâ</p>
                                <h2>ÊåÅ‰ªìÁ≠õÈÄâ</h2>
                            </div>
                            <div class="flex gap-2 items-center">
                                <input class="input" placeholder="SymbolÔºåÂ¶Ç BTCUSDT" v-model="positions.symbol" @keyup.enter="loadPositions(true)">
                                <button class="pill-btn" @click="loadPositions(true)">Êü•ËØ¢</button>
                            </div>
                        </div>
                    </div>
                    <div class="notion-block">
                            <div class="block-header">
                                <div>
                                    <p class="notion-section-title">‰ªì‰ΩçÂàóË°®</p>
                                    <h2>Red Book</h2>
                                </div>
                            <div class="flex gap-2 items-center">
                                <div class="muted">Page [[ positions.page ]]</div>
                                <button class="pill-btn sm"
                                        @click.stop="refreshPositionsPagePnL"
                                        :disabled="positions.loading || positions.refreshing || !positions.items.length">
                                    Âà∑Êñ∞Áõà‰∫è
                                </button>
                            </div>
                        </div>
                        <div v-if="positions.loading" class="block-skeleton">Âä†ËΩΩ‰ªì‰Ωç...</div>
                        <div v-else>
                            <div v-if="positions.error" class="callout error">[[ positions.error ]]</div>
                            <div class="pos-grid" v-if="positions.items.length">
                                <div class="pos-card" v-for="p in positions.items" :key="p.trade_id" @click="openPosition(p.trade_id)">
                                    <div>
                                        <div class="pos-main-header">
                                            <div class="pos-symbol">[[ p.symbol ]]</div>
                                            <span class="pos-status" :class="statusBadgeClass(p.status)">[[ statusLabel(p.status) ]]</span>
                                        </div>
                                        <div class="pos-meta">[[ (p.side || '').toUpperCase() ]] ¬∑ x[[ p.leverage ]]</div>
                                        <div class="pos-sub mt-2">Entry [[ formatNumber(p.entry_price) ]]</div>
                                    </div>
                                <div class="text-right">
                                    <div class="pos-pnl" :class="p.pnl_ratio>0 ? 'positive' : (p.pnl_ratio<0 ? 'negative' : '')">[[ formatUSD(p.pnl_usd) ]]</div>
                                    <div class="pos-sub">ROE [[ formatPercent(p.pnl_ratio) ]]</div>
                                    <!-- realized pnl removed -->
                                    <div class="pos-sub">Êú™ÂÆûÁé∞ [[ formatUSD(p.unrealized_pnl_usd) ]]</div>
                                    <div class="pos-sub mt-2">SL [[ p.stop_loss ? formatNumber(p.stop_loss) : '--' ]] / TP [[ p.take_profit ? formatNumber(p.take_profit) : '--' ]]</div>
                                    <div class="pos-sub">Ë∑ù SL [[ formatPercent(stopLossDistancePct(p)) ]] ¬∑ ÊúÄËøëËß¶ÂèëÁ∫ø [[ formatPercent(nearestTriggerDistancePct(p)) ]]</div>
                                </div>
                            </div>
                        </div>
                            <p v-else class="muted italic">ÊöÇÊó†ÊåÅ‰ªì„ÄÇ</p>
                        </div>
                        <div class="pager" v-if="positions.total > positions.pageSize">
                            <button class="pill-btn" :disabled="positions.page<=1" @click="changePositionPage(-1)">‰∏ä‰∏ÄÈ°µ</button>
                            <span class="muted">Á¨¨ [[ positions.page ]] È°µ</span>
                            <button class="pill-btn" :disabled="positions.page>=positionTotalPages" @click="changePositionPage(1)">‰∏ã‰∏ÄÈ°µ</button>
                        </div>
                    </div>
                    <div class="notion-block" v-if="positions.closed && positions.closed.length">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">Â∑≤Âπ≥‰ªì</p>
                                <h2>Closed Positions</h2>
                            </div>
                        </div>
                        <div class="pos-grid">
                            <div class="pos-card" v-for="p in positions.closed" :key="'closed-'+p.trade_id" @click="openPosition(p.trade_id)">
                                <div>
                                    <div class="pos-main-header">
                                        <div class="pos-symbol">[[ p.symbol ]]</div>
                                        <span class="pos-status" :class="statusBadgeClass(p.status)">[[ statusLabel(p.status) ]]</span>
                                    </div>
                                    <div class="pos-meta">[[ (p.side || '').toUpperCase() ]] ¬∑ x[[ p.leverage ]]</div>
                                    <div class="pos-sub mt-2">Entry [[ formatNumber(p.entry_price) ]] ¬∑ Exit [[ formatNumber(p.exit_price) ]]</div>
                                    <div class="pos-sub">ÊåÅ‰ªì [[ formatDuration(p.holding_ms) ]]</div>
                                </div>
                                <div class="text-right">
                                    <div class="pos-pnl" :class="p.pnl_ratio>0 ? 'positive' : (p.pnl_ratio<0 ? 'negative' : '')">
                                        [[ p.pnl_ratio>0 ? 'Â∑≤ÁõàÂà© ' : (p.pnl_ratio<0 ? 'Â∑≤‰∫èÊçü ' : '') ]][[ formatUSD(p.pnl_usd) ]]
                                    </div>
                                    <div class="pos-sub">ROE [[ formatPercent(p.pnl_ratio) ]]</div>
                                    <!-- realized pnl removed -->
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section v-if="view==='manualOpen'" class="stack">
                    <div class="notion-block">
                            <div class="block-header">
                                <div>
                                    <p class="notion-section-title">Manual Trade</p>
                                    <h2>ÊâãÂä®ÂºÄ‰ªìÔºàÂÖçÂÆ°Ôºâ</h2>
                                    <p class="muted">‚ö†Ô∏è ËØ•Êìç‰ΩúË∑≥Ëøá AI ÂÆ°Êü•ÔºåÁõ¥Êé•Êé®ÈÄÅËá≥ FreqtradeÔºåËØ∑Ë∞®ÊÖéÂ°´ÂÜôÊØè‰∏Ä‰∏™ÂèÇÊï∞„ÄÇ</p>
                                </div>
                            <div class="actions items-end">
                                <div class="text-right mr-4">
                                    <p class="muted">ÊúÄÊñ∞‰ª∑ [[ formatNumber(manualOpen.price.last) ]]</p>
                                    <p class="muted text-xs">H [[ formatNumber(manualOpen.price.high) ]] ¬∑ L [[ formatNumber(manualOpen.price.low) ]]</p>
                                </div>
                            </div>
                        </div>
                        <div class="callout warning">
                            <strong>Êó†ÈúÄÂÆ°Êü•Ôºö</strong>ËØ•Ë°®ÂçïÁî®‰∫é‰∫∫Â∑•‰ø°Âè∑ÊàñÁ¥ßÊÄ•ÂºÄ‰ªìÔºåÊèê‰∫§ÂêéÁ´ãÂç≥ÊâßË°åÔºåÁ≥ªÁªü‰ªÖËøõË°åÂü∫Á°ÄÊ†°È™åÔºàTier ÊØî‰æã=100%„ÄÅÊ≠¢Êçü/Ê≠¢ÁõàÊñπÂêëÊ≠£Á°ÆÔºâ„ÄÇ
                        </div>
	                        <div class="grid gap-4 form-grid" style="grid-template-columns: repeat(12, minmax(0, 1fr));">
	                            <label class="form-row col-span-4">
	                                <span>‰∫§ÊòìÂØπ</span>
	                                <select class="input" v-model="manualOpen.symbol">
	                                    <option v-for="sym in defaultSymbols" :value="sym" :key="sym">[[ sym ]]</option>
	                                </select>
	                            </label>
	                            <label class="form-row col-span-8">
	                                <span>Exit Plan Á≠ñÁï•ÁªÑÂêà</span>
	                                <select class="input" v-model="manualOpen.exit_combo">
	                                    <option disabled value="">ËØ∑ÈÄâÊã©Á≠ñÁï•</option>
	                                    <option v-for="c in availableExitCombos" :value="c.key" :key="c.key">[[ c.label ]]Ôºà[[ c.key ]]Ôºâ</option>
	                                </select>
	                            </label>
	                            <div class="form-row col-span-4">
	                                <span>ÊñπÂêë</span>
	                                <div class="flex gap-2">
	                                    <button class="pill-btn" :class="{primary: manualOpen.side==='long'}" @click.prevent="manualOpen.side='long'">ÂÅöÂ§ö</button>
	                                    <button class="pill-btn danger" :class="{primary: manualOpen.side==='short'}" @click.prevent="manualOpen.side='short'">ÂÅöÁ©∫</button>
	                                </div>
	                            </div>
	                            <label class="form-row col-span-4">
	                                <span>Êù†ÊùÜ</span>
	                                <input class="input" type="number" min="1" step="1" v-model.number="manualOpen.leverage">
	                            </label>
                            <label class="form-row col-span-4">
                                <span>ÂºÄ‰ªì‰ª∑Ê†º</span>
                                <div class="flex gap-2 items-center">
                                    <input class="input" type="number" min="0" step="0.0001" v-model.number="manualOpen.entry_price">
                                    <button class="pill-btn" @click="fetchAndFillEntryPrice" :disabled="manualOpen.loadingPrice || !manualOpen.symbol">Ëé∑ÂèñÂΩìÂâç‰ª∑</button>
                                </div>
                                <div class="mt-2 flex items-center gap-4">
                                    <div class="flex-1">
                                        <div class="flex justify-between text-xs muted mb-1">
                                            <span>Ê≠¢ÁõàÂÅèÁßª [[ formatPercent(manualOpen.tp_pct) ]]</span>
                                            <span>Ê≠¢ÊçüÂÅèÁßª [[ formatPercent(manualOpen.sl_pct) ]]</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <input class="input range" type="range" min="0" max="0.1" step="0.001" v-model.number="manualOpen.tp_pct" @input="applyPctTargets">
                                            <input class="input range" type="range" min="0" max="0.1" step="0.001" v-model.number="manualOpen.sl_pct" @input="applyPctTargets">
                                        </div>
                                        <p class="muted text-xs mt-1">ÊãñÂä®ÂèØÂø´ÈÄüÂ°´ÂÖÖÂçïÊÆµÊ≠¢Áõà/Ê≠¢Êçü‰ª∑Ê†ºÔºå‰πüÂèØÊâãÂä®ËæìÂÖ•„ÄÇ</p>
                                    </div>
                                </div>
                            </label>

	                            <label class="form-row col-span-4">
	                                <span>‰ªì‰ΩçÔºàUSDÔºâ</span>
	                                <input class="input" type="number" min="1" step="10" v-model.number="manualOpen.position_size_usd">
	                            </label>
	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasSlSingle">
	                                <span>Ê≠¢ÊçüÁõÆÊ†á‰ª∑</span>
	                                <input class="input" type="number" step="0.0001" v-model.number="manualOpen.stop_loss">
	                            </label>
	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasTpSingle">
	                                <span>Ê≠¢ÁõàÁõÆÊ†á‰ª∑</span>
	                                <input class="input" type="number" step="0.0001" v-model.number="manualOpen.take_profit">
	                            </label>

	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasTpTiers">
	                                <span>Tier1 ÁõÆÊ†á</span>
	                                <input class="input" type="number" step="0.0001" v-model.number="manualOpen.tier1_target">
	                            </label>
	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasTpTiers">
	                                <span>Tier1 ÊØî‰æã (0-1)</span>
	                                <input class="input" type="number" min="0" max="1" step="0.01" v-model.number="manualOpen.tier1_ratio">
	                            </label>

	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasTpTiers">
	                                <span>Tier2 ÁõÆÊ†á</span>
	                                <input class="input" type="number" step="0.0001" v-model.number="manualOpen.tier2_target">
	                            </label>
	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasTpTiers">
	                                <span>Tier2 ÊØî‰æã (0-1)</span>
	                                <input class="input" type="number" min="0" max="1" step="0.01" v-model.number="manualOpen.tier2_ratio">
	                            </label>

	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasTpTiers">
	                                <span>Tier3 ÁõÆÊ†á</span>
	                                <input class="input" type="number" step="0.0001" v-model.number="manualOpen.tier3_target">
	                            </label>
	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasTpTiers">
	                                <span>Tier3 ÊØî‰æã (0-1)</span>
	                                <input class="input" type="number" min="0" max="1" step="0.01" v-model.number="manualOpen.tier3_ratio">
	                            </label>

	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasSlTiers">
	                                <span>SL1 ÁõÆÊ†á</span>
	                                <input class="input" type="number" step="0.0001" v-model.number="manualOpen.sl_tier1_target">
	                            </label>
	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasSlTiers">
	                                <span>SL1 ÊØî‰æã (0-1)</span>
	                                <input class="input" type="number" min="0" max="1" step="0.01" v-model.number="manualOpen.sl_tier1_ratio">
	                            </label>

	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasSlTiers">
	                                <span>SL2 ÁõÆÊ†á</span>
	                                <input class="input" type="number" step="0.0001" v-model.number="manualOpen.sl_tier2_target">
	                            </label>
	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasSlTiers">
	                                <span>SL2 ÊØî‰æã (0-1)</span>
	                                <input class="input" type="number" min="0" max="1" step="0.01" v-model.number="manualOpen.sl_tier2_ratio">
	                            </label>

	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasSlTiers">
	                                <span>SL3 ÁõÆÊ†á</span>
	                                <input class="input" type="number" step="0.0001" v-model.number="manualOpen.sl_tier3_target">
	                            </label>
	                            <label class="form-row col-span-4" v-if="manualOpenFlags.hasSlTiers">
	                                <span>SL3 ÊØî‰æã (0-1)</span>
	                                <input class="input" type="number" min="0" max="1" step="0.01" v-model.number="manualOpen.sl_tier3_ratio">
	                            </label>

                            <label class="form-row col-span-12">
                                <span>Â§áÊ≥® / ÁêÜÁî±ÔºàÂÜôÂÖ•ÂÜ≥Á≠ñÊó•ÂøóÔºâ</span>
	                                <input class="input" type="text" v-model="manualOpen.reason" placeholder="‰æãÂ¶ÇÔºöÂèåÂ∫ïÂΩ¢ÊÄÅ + FOMC Á©∫Á™óÂè£Ôºå‰∫∫Â∑•‰ø°Âè∑">
	                            </label>
	                        </div>
	                        <div class="muted text-sm mt-4" v-if="manualOpenFlags.hasTpTiers">
	                            Ê≠¢Áõà Tier ÊØî‰æãÂêàËÆ°Ôºö[[ formatPercent(manualTierSum) ]] ÔºàÈúÄÁ≠â‰∫é 100%Ôºâ„ÄÇÂ¶ÇÊûúÈúÄË¶Å 33/33/34ÔºåÂèØÁõ¥Êé•Â°´ 0.33/0.33/0.34„ÄÇ
	                        </div>
	                        <div class="muted text-sm mt-2" v-if="manualOpenFlags.hasSlTiers">
	                            Ê≠¢Êçü Tier ÊØî‰æãÂêàËÆ°Ôºö[[ formatPercent(manualSlTierSum) ]] ÔºàÈúÄÁ≠â‰∫é 100%Ôºâ„ÄÇÂ¶ÇÊûúÈúÄË¶Å 33/33/34ÔºåÂèØÁõ¥Êé•Â°´ 0.33/0.33/0.34„ÄÇ
	                        </div>
	                        <div class="callout mt-4" v-if="manualOpenPreview && manualOpenPreview.lines && manualOpenPreview.lines.length">
	                            <strong>Ëß¶Âèë‰ª∑Ê†ºÈ¢ÑËßàÔºö</strong>
	                            <div class="mt-2">
	                                <div class="flex justify-between" v-for="l in manualOpenPreview.lines" :key="l.kind+'-'+l.label">
	                                    <span>[[ l.label ]] ¬∑ [[ l.kind ]] ¬∑ ratio [[ formatPercent(l.ratio) ]]</span>
	                                    <span>[[ formatNumber(l.price) ]] <span class="muted text-xs" v-if="l.pct !== null && l.pct !== undefined">([[ formatPercent(l.pct) ]])</span></span>
	                                </div>
	                            </div>
	                        </div>
	                        <div class="callout error mt-4" v-if="manualOpenPreview && manualOpenPreview.errors && manualOpenPreview.errors.length">
	                            <strong>ËØ∑ÂÖà‰øÆÊ≠£Ôºö</strong> [[ manualOpenPreview.errors[0] ]]
	                        </div>
	                        <div class="mt-4 flex justify-between items-center">
	                            <p class="muted text-xs">Êèê‰∫§ÂêéÁ´ãÂç≥ÊâßË°åÔºåÂª∫ËÆÆÂú®Âà∑Êñ∞ÂΩìÂâç‰ª∑Âêé 30 ÁßíÂÜÖÂÆåÊàê„ÄÇ</p>
	                            <button class="pill-btn primary" @click="openManualConfirm" :disabled="manualOpen.submitting">‰∏ã‰∏ÄÊ≠•ÔºöÁ°ÆËÆ§ÂºÄ‰ªì</button>
	                        </div>
	                    </div>
	                </section>

                <section v-if="view==='positionDetail'" class="stack">
                            <div class="notion-block">
                                <div class="block-header">
                                    <div>
                                        <p class="notion-section-title">‰ªì‰ΩçËØ¶ÊÉÖ</p>
                                        <div class="pos-main-header">
                                            <h2>Trade #[[ positionDetail.tradeId ]]</h2>
                                            <span v-if="positionDetail.data"
                                                  class="pos-status"
                                                  :class="statusBadgeClass(positionDetail.data.status)">
                                                [[ statusLabel(positionDetail.data.status) ]]
                                            </span>
                                        </div>
                                        <div class="muted" v-if="positionDetail.data && positionDetail.data.opened_at">
                                            ÂºÄ‰ªì [[ formatDateTime(positionDetail.data.opened_at) ]]
                                            <span v-if="positionDetail.data.status==='closed' && positionDetail.data.closed_at">
                                                ¬∑ Âπ≥‰ªì [[ formatDateTime(positionDetail.data.closed_at) ]]
                                            </span>
                                        </div>
                                    </div>
                                    <div class="actions">
                                        <button class="pill-btn" @click="switchView('positions')">ËøîÂõûÂàóË°®</button>
                                        <button class="pill-btn danger" @click="forceClosePosition" :disabled="positionDetail.loading || (positionDetail.data && positionDetail.data.status==='closed')">ÊâãÂä®ÂÖ®Âπ≥</button>
                                    </div>
                                </div>
                                <div v-if="positionDetail.loading" class="block-skeleton">Âä†ËΩΩ‰ªì‰ΩçËØ¶ÊÉÖ...</div>
                                <div v-else>
                                    <div v-if="positionDetail.error" class="callout error">[[ positionDetail.error ]]</div>
                                    <div v-if="positionDetail.data" class="detail-grid">
                                        <div class="detail-card">
                                            <p class="muted">Ê†áÁöÑ / ÊñπÂêë</p>
                                            <h3>[[ positionDetail.data.symbol ]] ¬∑ [[ (positionDetail.data.side || '').toUpperCase() ]] x[[ positionDetail.data.leverage ]]</h3>
                                            <p class="muted">Entry [[ formatNumber(positionDetail.data.entry_price) ]] ¬∑ Current [[ formatNumber(positionDetail.data.current_price) ]]</p>
                                        </div>
                                        <div class="detail-card">
                                            <p class="muted">Áõà‰∫è</p>
                                            <div class="flex justify-between items-center">
                                                <h3 :class="positionDetail.data.pnl_ratio>0 ? 'text-emerald-600' : (positionDetail.data.pnl_ratio<0 ? 'text-red-600' : '')">[[ formatUSD(positionDetail.data.pnl_usd) ]]</h3>
                                                <button class="pill-btn sm"
                                                        @click="refreshPositionPnL"
                                                        :disabled="positionDetail.pnlRefreshing || positionDetail.loading">
                                                    Âà∑Êñ∞Áõà‰∫è
                                                </button>
                                            </div>
                                            <p class="muted">ROE [[ formatPercent(positionDetail.data.pnl_ratio) ]]</p>
                                        </div>
                                        <div class="detail-card">
                                            <p class="muted">‰ªì‰Ωç‰ª∑ÂÄº / ‰øùËØÅÈáë</p>
                                            <h3>Âêç‰πâ‰ª∑ÂÄº [[ formatNumber(positionDetail.data.position_value) ]] / ‰øùËØÅÈáë [[ formatNumber(positionDetail.data.stake) ]]</h3>
                                            <p class="muted">Â∑≤ÊåÅÊúâ [[ formatDuration(positionDetail.data.holding_ms) ]]</p>
                                        </div>
                                    </div>

                            <!-- TradingView KÁ∫øÂõæ -->
                            <div class="notion-block mt-4" v-if="positionDetail.data">
                                <div class="block-header">
                                    <div>
                                        <p class="notion-section-title">KÁ∫øÂõæ</p>
                                        <h3>TradingView ¬∑ Á≠ñÁï•Ê†áËÆ∞</h3>
                                    </div>
                                    <div class="muted">
                                        <span class="chart-legend current">‚îÅ Current</span>
                                        <span class="chart-legend tp">‚îÖ TP</span>
                                        <span class="chart-legend sl">‚îÖ SL</span>
                                        <span class="chart-legend note"
                                              v-if="positionDetail.data.stop_loss || positionDetail.data.take_profit">
                                            SL [[ formatNumber(positionDetail.data.stop_loss) ]]
                                            ¬∑ TP [[ formatNumber(positionDetail.data.take_profit) ]]
                                        </span>
                                    </div>
                                </div>
                                <div class="tradingview-widget-container" style="height: 420px; border-radius: 8px; overflow: hidden;">
                                    <div :id="'tv-widget-'+positionDetail.tradeId" style="height: 100%;"></div>
                                </div>
                                <div class="chart-price-levels mt-2" v-if="positionDetail.data">
                                    <div class="exit-levels-wrapper compact" v-if="exitLevels.length">
                                        <div class="exit-levels-chart compact">
                                            <div class="exit-level current"
                                                 v-if="positionDetail.data.current_price"
                                                 :style="{ top: (100 - currentPricePosition) + '%' }">
                                                <span class="exit-level-label">Current</span>
                                                <div class="exit-level-line"></div>
                                                <span class="exit-level-price">[[ formatNumber(positionDetail.data.current_price) ]]</span>
                                                <span class="exit-level-indicator">‚óè</span>
                                            </div>
                                            <div class="exit-level"
                                                 v-for="lv in exitLevels"
                                                 :key="lv.id"
                                                 :class="[lv.type, lv.status==='triggered' ? 'triggered' : '']"
                                                 :style="{ top: (100 - lv.position) + '%' }">
                                                <span class="exit-level-label">[[ lv.label ]]</span>
                                                <div class="exit-level-line"></div>
                                                <span class="exit-level-price">[[ formatNumber(lv.price) ]]</span>
                                                <span class="exit-level-ratio" v-if="lv.ratio !== null && lv.ratio !== undefined">ratio [[ formatPercent(lv.ratio) ]]</span>
                                                <span class="exit-level-ratio" v-if="lv.hitPrice">Ëß¶Ëææ [[ formatNumber(lv.hitPrice) ]]</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="chart-level-chips" v-if="chartLevelChips.length">
                                        <div class="price-level"
                                             v-for="lv in chartLevelChips"
                                             :key="lv.id"
                                             :class="[lv.type, lv.status==='triggered' ? 'triggered' : '']">
                                            <span class="level-label">[[ lv.label ]]</span>
                                            <span class="level-price">[[ formatNumber(lv.price) ]]</span>
                                            <span class="level-ratio" v-if="lv.ratio !== null && lv.ratio !== undefined">ratio [[ formatPercent(lv.ratio) ]]</span>
                                            <span class="level-ratio" v-if="lv.pct !== null && lv.pct !== undefined">Œî [[ formatPercent(lv.pct) ]]</span>
                                            <span class="level-hit" v-if="lv.hitPrice">Ëß¶Ëææ [[ formatNumber(lv.hitPrice) ]]</span>
                                        </div>
                                    </div>
                                    <div class="muted text-xs" v-if="exitLevels.length">
                                        TradingView Â§ñÈÉ®ÂµåÂÖ•‰∏çÊîØÊåÅÂú®ÂõæÂÜÖÁõ¥Êé•ÁîªÁ∫øÔºåÂ∑≤Âú®Âõæ‰∏ãÊ®°ÊãüÊ†áËÆ∞„ÄÇ
                                    </div>
                                </div>
                            </div>

                            <div class="notion-block mt-6" v-if="positionDetail.data">
                                <div class="block-header">
                                    <div>
                                        <p class="notion-section-title">Á≠ñÁï•Ë∞ÉÊï¥</p>
                                        <h3>Update Exit Plan</h3>
                                    </div>
                                    <div class="muted">‰ªÖË∞ÉÊï¥Êú™Ëß¶ÂèëÊÆµ‰Ωç</div>
                                </div>
                                <div v-if="positionDetail.planInstancesLoading" class="block-skeleton">Âä†ËΩΩÁ≠ñÁï•...</div>
                                <div v-else>
                                    <div v-if="positionDetail.planInstancesError" class="callout error">[[ positionDetail.planInstancesError ]]</div>
                                    <div v-if="!planTierGroups.length && !atrComponents.length" class="muted italic">ÊöÇÊó†ÂèØË∞ÉÊï¥ÁöÑ Exit Plan„ÄÇ</div>
                                    <template v-else>
                                        <template v-if="planTierGroups.length">
                                            <div class="tier-board" v-for="group in planTierGroups" :key="group.key">
                                                <div class="tier-row">
                                                    <div class="tier-name">[[ group.label ]]</div>
                                                    <div class="tier-target muted">ÁõÆÊ†á‰ª∑</div>
                                                    <div class="tier-ratio muted">ÊØî‰æã</div>
                                                    <div class="tier-status muted">Áä∂ÊÄÅ</div>
                                                </div>
                                                <div class="tier-row" v-for="tier in group.tiers" :key="tier.component">
                                                    <div class="tier-name">[[ tier.name ]]</div>
                                                    <div class="tier-target">
                                                        <input class="input" type="number" step="0.0001"
                                                               :disabled="positionDetail.data.status==='closed' || !tier.editable"
                                                               v-model.number="tierEdits[tier.component].target_price">
                                                    </div>
                                                    <div class="tier-ratio">
                                                        <input class="input" type="number" min="0" max="1" step="0.01"
                                                               :disabled="positionDetail.data.status==='closed' || !tier.editable"
                                                               v-model.number="tierEdits[tier.component].ratio">
                                                    </div>
                                                    <div class="tier-status">[[ tier.statusLabel ]]</div>
                                                </div>
                                            </div>
                                        </template>

                                        <div class="tier-board mt-4" v-if="atrComponents.length">
                                            <div class="tier-row">
                                                <div class="tier-name">ATR ËøΩË∏™ÁªÑ‰ª∂</div>
                                                <div class="tier-target muted">trigger_mult</div>
                                                <div class="tier-ratio muted">trail_mult</div>
                                                <div class="tier-status muted">ÂΩìÂâç(trigger/trail)</div>
                                            </div>
                                            <template v-for="item in atrComponents" :key="item.component">
                                                <div class="tier-row" v-if="atrEdits[item.component]">
                                                    <div class="tier-name">[[ item.label ]]</div>
                                                    <div class="tier-target">
                                                        <input class="input" type="number" step="0.1"
                                                               :disabled="positionDetail.data.status==='closed' || !item.editable"
                                                               v-model.number="atrEdits[item.component].trigger_multiplier">
                                                    </div>
                                                    <div class="tier-ratio">
                                                        <input class="input" type="number" step="0.1"
                                                               :disabled="positionDetail.data.status==='closed' || !item.editable"
                                                               v-model.number="atrEdits[item.component].trail_multiplier">
                                                    </div>
                                                    <div class="tier-status">[[ formatPercent(item.trigger_pct) ]] / [[ formatPercent(item.trail_pct) ]]</div>
                                                </div>
                                            </template>
                                        </div>
                                        <div class="callout warning mt-4" v-if="planEditError">[[ planEditError ]]</div>
                                        <div class="notion-block mt-4" v-if="planEditPreviewLines.length">
                                            <div class="block-header">
                                                <h3>ÂèòÊõ¥È¢ÑËßà</h3>
                                                <div class="muted">‰ªÖÂ±ïÁ§∫ÊúâÂèòÂåñÁöÑÂ≠óÊÆµ</div>
                                            </div>
                                            <pre class="step-text">[[ planEditPreviewLines.join('\\n') ]]</pre>
                                        </div>
                                        <div class="mt-4 flex justify-end">
                                            <button class="pill-btn primary" @click="submitTierEdits"
                                                    :disabled="tierEditsSubmitting || positionDetail.data.status==='closed' || !planEditPreviewLines.length">
                                                Êèê‰∫§Á≠ñÁï•‰øÆÊîπ
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <div class="notion-block mt-6">
                                <div class="block-header">
                                    <h3>Á≠ñÁï•ÂèòÊõ¥Êó•Âøó</h3>
                                    <div class="muted">Êù•Ëá™ strategy_change_log</div>
                                </div>
                                <div v-if="positionDetail.planChangesLoading" class="block-skeleton">Âä†ËΩΩÂèòÊõ¥Êó•Âøó...</div>
                                <div v-else>
                                    <div v-if="!positionDetail.planChanges.length" class="muted italic">ÊöÇÊó†ÂèòÊõ¥Êó•Âøó</div>
                                    <div class="log-list" v-else>
                                        <div class="plan-change-group" v-for="g in planChangeGroups" :key="g.key">
                                            <div class="plan-change-head">
                                                <div>
                                                    <div class="plan-change-time">[[ formatDateTime(g.createdAt) ]]</div>
                                                    <div class="muted text-xs">
                                                        [[ g.sourceLabel ]]
                                                        <span v-if="g.traceShort"> ¬∑ trace [[ g.traceShort ]]</span>
                                                    </div>
                                                </div>
                                                <div class="muted text-xs">[[ (g.logs && g.logs.length) || 0 ]] Êù°</div>
                                            </div>
                                            <ul class="plan-change-lines" v-if="g.lines && g.lines.length">
                                                <li v-for="(line, idx) in g.lines" :key="g.key+'-'+idx">[[ line ]]</li>
                                            </ul>
                                            <div class="muted italic" v-else>ÊöÇÊó†ÂèØÂ±ïÁ§∫ÂÜÖÂÆπ</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="notion-block mt-6">
                                <div class="block-header">
                                    <h3>‰∫ã‰ª∂ÊµÅÊ∞¥</h3>
                                    <div class="muted">Êù•Ëá™ trade_operation_log</div>
                                </div>
                                <div v-if="positionDetail.tradeEventsLoading" class="block-skeleton">Âä†ËΩΩ‰∫ã‰ª∂...</div>
                                <div v-else>
                                    <div v-if="positionDetail.tradeEventsError" class="callout error">[[ positionDetail.tradeEventsError ]]</div>
                                    <div v-if="!positionDetail.tradeEvents.length" class="muted italic">ÊöÇÊó†‰∫ã‰ª∂</div>
                                    <div class="log-list" v-else>
                                        <div class="log-row" v-for="ev in positionDetail.tradeEvents" :key="ev.timestamp">
                                            <div>[[ formatDateTime(ev.timestamp) ]]</div>
                                            <div class="muted">[[ operationLabel(ev.operation) ]]</div>
                                            <div class="muted">[[ (ev.details && (ev.details.reason || ev.details.event_type)) || '' ]]</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section v-if="view==='logs'" class="stack">
                    <div class="notion-block">
                        <div class="block-header">
                            <div>
                                <p class="notion-section-title">ÂÆûÊó∂Êó•Âøó</p>
                                <h2>Logs</h2>
                                <p class="muted">ÊãâÂèñÂêéÁ´Ø log_path/llm_log_path ÊúÄËøëËã•Âπ≤Ë°å</p>
                            </div>
                            <div class="actions">
                                <select class="input" v-model="logs.name" @change="loadLogs(true)">
                                    <option v-for="name in logs.available" :key="name" :value="name">[[ name ]]</option>
                                </select>
                                <button class="pill-btn" @click="loadLogs(true)" :disabled="logs.loading">Âà∑Êñ∞</button>
                            </div>
                        </div>
                        <div v-if="logs.loading" class="block-skeleton">Âä†ËΩΩÊó•Âøó...</div>
                        <div v-else>
                            <div v-if="logs.error" class="callout error">[[ logs.error ]]</div>
                            <div class="log-view" v-if="logs.lines.length">
                                <div class="log-line" v-for="(line, idx) in logs.lines" :key="idx">[[ line ]]</div>
                            </div>
                            <p v-else class="muted italic">ÊöÇÊó†Êó•ÂøóÂÜÖÂÆπ</p>
                        </div>
                    </div>
                </section>
            </main>
	        </div>
	        <div v-if="toast.message" class="toast" :class="toast.type">[[ toast.message ]]</div>
	        <div v-if="manualOpen.showConfirm" class="image-modal" @click.self="manualOpen.showConfirm=false">
	            <div class="image-modal-content">
	                <div>
	                    <p class="notion-section-title">Manual Trade</p>
	                    <h3>Á°ÆËÆ§ÂºÄ‰ªì</h3>
	                    <p class="muted text-sm">Â∞ÜË∑≥Ëøá AI ÂÆ°Êü•ÔºåÁõ¥Êé•Êé®ÈÄÅËá≥ Freqtrade„ÄÇ</p>
	                </div>
	                <div class="callout">
	                    <div class="flex justify-between">
	                        <span><strong>Symbol</strong> [[ manualOpenPreview.symbol ]]</span>
	                        <span><strong>Side</strong> [[ (manualOpenPreview.side || '').toUpperCase() ]]</span>
	                    </div>
	                    <div class="flex justify-between mt-2">
	                        <span><strong>Leverage</strong> x[[ manualOpen.leverage ]]</span>
	                        <span><strong>Size</strong> [[ formatNumber(manualOpen.position_size_usd) ]] USD</span>
	                    </div>
	                    <div class="flex justify-between mt-2">
	                        <span><strong>Entry</strong> [[ formatNumber(manualOpen.entry_price) ]]</span>
	                        <span><strong>Strategy</strong> [[ manualOpenPreview.comboLabel ]]</span>
	                    </div>
	                    <div class="mt-3" v-if="manualOpenPreview.lines && manualOpenPreview.lines.length">
	                        <div class="muted text-xs mb-2">Ëß¶Âèë‰ª∑Ê†ºÊòéÁªÜ</div>
	                        <div class="flex justify-between" v-for="l in manualOpenPreview.lines" :key="'confirm-'+l.kind+'-'+l.label">
	                            <span>[[ l.label ]] ¬∑ [[ l.kind ]] ¬∑ ratio [[ formatPercent(l.ratio) ]]</span>
	                            <span>[[ formatNumber(l.price) ]] <span class="muted text-xs" v-if="l.pct !== null && l.pct !== undefined">([[ formatPercent(l.pct) ]])</span></span>
	                        </div>
	                    </div>
	                    <div class="mt-3" v-if="manualOpen.reason">
	                        <div class="muted text-xs mb-2">Â§áÊ≥®</div>
	                        <div>[[ manualOpen.reason ]]</div>
	                    </div>
	                </div>
	                <div class="image-modal-actions">
	                    <button class="pill-btn" @click="manualOpen.showConfirm=false">ÂèñÊ∂à</button>
	                    <button class="pill-btn primary" @click="confirmManualOpen" :disabled="manualOpen.submitting">Á°ÆËÆ§ÂºÄ‰ªì</button>
	                </div>
	            </div>
	        </div>
	        <div v-if="imagePreview.visible" class="image-modal" @click.self="closeImagePreview">
	            <div class="image-modal-content">
	                <img :src="imagePreview.src" :alt="imagePreview.desc || 'LLM Attachment'">
	                <p class="image-modal-desc" v-if="imagePreview.desc">[[ imagePreview.desc ]]</p>
                <div class="image-modal-actions">
                    <a class="pill-btn" :href="imagePreview.src" target="_blank" rel="noopener">Âú®Êñ∞Ê†áÁ≠æÊâìÂºÄ</a>
                    <button class="pill-btn" @click="closeImagePreview">ÂÖ≥Èó≠</button>
                </div>
            </div>
        </div>
    </script>

    <div id="app"></div>

    <script>
        window.__APP_INIT__ = {
            view: "{{ if .InitialView }}{{ .InitialView }}{{ else }}desk{{ end }}",
            decisionId: {{ if .DecisionID }}{{ .DecisionID }}{{ else }}null{{ end }},
        traceId: {{ if .TraceID }}{{ printf "%q" .TraceID }}{{ else }}null{{ end }},
        tradeId: {{ if .TradeID }}{{ .TradeID }}{{ else }}null{{ end }},
        symbol: {{ if .Symbol }}{{ printf "%q" .Symbol }}{{ else }}""{{ end }},
        selectedSymbols: {{ if .SelectedSymbols }}{{ toJSON .SelectedSymbols }}{{ else }}[]{{ end }},
        defaultSymbols: {{ toJSON .DefaultSymbols }},
        symbolDetails: {{ toJSON .SymbolDetails }},
        };
    </script>
    <script src="/static/js/admin-app.js"></script>
</body>

</html>
